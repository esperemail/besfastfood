<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BES Admin</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#a7b0c0;
      --txt:#e9eef8;
      --line: rgba(255,255,255,.10);
      --good:#2E7D32;
      --warn:#FFC107;
      --bad:#D32F2F;
      --btn:#1b2a4a;
      --btn2:#22355e;
      --radius:16px;
      --shadow: 0 12px 32px rgba(0,0,0,.35);

      --newRow: rgba(255,193,7,.12);
      --recvRow: rgba(255,193,7,.08);
      --workRow: rgba(46,125,50,.07);
      --cancelRow: rgba(211,47,47,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(255,193,7,.12), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(211,47,47,.10), transparent 55%),
        var(--bg);
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:50;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(11,18,32,.85);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1200px;margin:auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sp{justify-content:space-between}
    .brand{font-weight:1000;letter-spacing:1px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-weight:800;font-size:12px}

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;border-radius:999px;
      font-weight:900;cursor:pointer;
    }
    .tab.active{background: linear-gradient(90deg, rgba(255,193,7,.25), rgba(255,152,0,.15)); border-color: rgba(255,193,7,.25)}

    .btn{
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:900;cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{background:var(--btn2)}
    .btn.good{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.28)}
    .btn.warn{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.28)}
    .btn.bad{background:rgba(211,47,47,.18);border-color:rgba(211,47,47,.28)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .content{padding:14px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;text-align:left}

    .muted{color:var(--muted);font-size:13px}
    .toast{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(46,125,50,.25);background:rgba(46,125,50,.12);color:rgba(185,255,210,.95);font-weight:900}
    .err{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(211,47,47,.25);background:rgba(211,47,47,.12);color:rgba(255,200,200,.95);font-weight:900}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:900;font-size:12px}
    .badge.good{border-color:rgba(46,125,50,.35);color:rgba(185,255,210,.95)}
    .badge.bad{border-color:rgba(211,47,47,.35);color:rgba(255,200,200,.95)}
    .badge.warn{border-color:rgba(255,193,7,.35);color:rgba(255,240,200,.95)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .grid{display:grid;grid-template-columns: 2fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .menuGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:560px){.menuGrid{grid-template-columns:1fr}}

    .prod{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.05);
      padding:10px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .mini{
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--txt);font-weight:900;cursor:pointer;
    }

    /* ‚úÖ Highlight commandes */
    tr.is-new td{ background: var(--newRow); }
    tr.is-received td{ background: var(--recvRow); }
    tr.is-working td{ background: var(--workRow); }
    tr.is-cancel td{ background: var(--cancelRow); }
    tr.is-new td{ animation: flash 1.2s ease-in-out 2; }
    @keyframes flash{
      0%{ filter:brightness(1.05); }
      50%{ filter:brightness(1.25); }
      100%{ filter:brightness(1.05); }
    }

    .twoCol{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:700px){.twoCol{grid-template-columns:1fr}}
    .small{font-size:12px}

    .noteBar{
      border:1px solid rgba(255,193,7,.25);
      background: rgba(255,193,7,.10);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      margin-bottom:12px;
      display:none;
    }

    /* ‚úÖ Livr√© */
    .deliveredBox{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      font-weight:900;
    }
    .deliveredBox input{
      width:18px;height:18px;
      accent-color: #2E7D32;
    }
    .idCell{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size:12px;
      color: rgba(233,238,248,.9);
      max-width: 160px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap row sp">
    <div class="row">
      <div class="brand">BES Admin</div>
      <div class="pill">Admin v2 ‚Ä¢ POS 80mm</div>
    </div>
    <div class="row">
      <button class="btn" id="refreshBtn" type="button">Actualiser</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="cardHead">
      <div class="tabs">
        <button class="tab active" data-tab="orders">Commandes</button>
        <button class="tab" data-tab="pending">En attente</button>
        <button class="tab" data-tab="products">Produits</button>
        <button class="tab" data-tab="place">Placer une commande</button>
         <button class="tab" data-tab="closeDay">Cl√¥ture journ√©e</button>
          <button class="tab" data-tab="histTx">Historique transactions</button>
          <button class="tab" data-tab="histRep">Historique rapports</button>
      </div>

      <div class="row" style="flex:1;justify-content:flex-end">
        <input id="adminKey" placeholder="ADMIN KEY (auto)" style="max-width:340px" />

        <!-- ‚úÖ Recherche ID commande -->
        <input id="orderIdSearch" placeholder="Recherche ID commande‚Ä¶" style="max-width:260px" />

        <!-- ‚úÖ Masquer livr√©s -->
        <label class="pill" style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="hideDelivered" type="checkbox" style="width:18px;height:18px;accent-color:#FFC107;margin:0">
          Masquer livr√©s
        </label>

        <select id="statusFilter" style="max-width:240px">
          <option value="">Tous statuts</option>
          <option>Re√ßue</option>
          <option>Pr√™t √† consommer</option>
          <option>Pr√™t √† emporter</option>
          <option>Pr√™t √† livrer</option>
          <option>Livr√©</option>
          <option>Annul√©e</option>
        </select>
      </div>
    </div>

    <div class="content">
      <div id="toast" class="toast"></div>
      <div id="err" class="err"></div>

      <!-- ORDERS -->
      <section id="tab-orders">
        <div class="card">
          <div class="content" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Type</th>
                  <th>Commande</th>
                  <th>Total</th>
                  <th>Statut</th>
                  <th>Livr√©</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="9" class="muted">Chargement‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="muted small" style="margin-top:10px">
          Astuce: les nouvelles commandes (non vues) apparaissent en <b>jaune</b>.
          Les commandes <b>Livr√©</b> descendent automatiquement en bas (ou masqu√©es si filtre activ√©).
        </div>
      </section>
      
    <!-- Pending -->   
<section id="tab-pending" style="display:none">
  <div class="card">
    <div class="cardHead">
      <b>Commandes en attente</b>
      <button class="btn" type="button" id="pendingReloadBtn">Recharger</button>
    </div>
    <div class="content" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>Date</th><th>ID</th><th>Client</th><th>Total</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="pendingTbody">
          <tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

      <!-- PRODUCTS -->
      <section id="tab-products" style="display:none">
        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <b>Produits</b>
              <div class="row">
                <button class="btn" id="reloadProductsBtn" type="button">Recharger</button>
              </div>
            </div>
            <div id="productsBox" class="content muted">Chargement‚Ä¶</div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Ajouter / Modifier</b>
              <div class="row">
                <button class="btn warn" id="reloadCatsBtn" type="button">Cat√©gories</button>
              </div>
            </div>
            <div class="content">
              <div class="twoCol">
                <div>
                  <label class="small muted">ProductID</label>
                  <input id="pf_id" placeholder="Ex: 10" />
                </div>
                <div>
                  <label class="small muted">Nom</label>
                  <input id="pf_name" placeholder="Ex: Burger BES" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Cat√©gorie (choisir)</label>
                  <select id="pf_catSelect"></select>
                </div>
                <div>
                  <label class="small muted">Cat√©gorie (nouvelle)</label>
                  <input id="pf_catNew" placeholder="Ex: Boisson" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Prix (HTG)</label>
                  <input id="pf_price" type="number" step="0.01" placeholder="Ex: 250" />
                </div>
                <div>
                  <label class="small muted">Stock</label>
                  <input id="pf_stock" type="number" step="1" placeholder="Ex: 20" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Ordre (optionnel)</label>
                  <input id="pf_order" type="number" step="1" placeholder="Ex: 1" />
                </div>
                <div>
                  <label class="small muted">Actif</label>
                  <select id="pf_active">
                    <option value="TRUE">TRUE (actif)</option>
                    <option value="FALSE">FALSE (d√©sactiv√©)</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <button class="btn good" id="saveProductBtn" type="button">Enregistrer</button>
                <button class="btn" id="fillFromSelectedBtn" type="button">Remplir depuis liste</button>
                <button class="btn bad" id="clearFormBtn" type="button">Vider</button>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div style="flex:1">
                  <label class="small muted">Ajuster stock rapide (ProductID)</label>
                  <input id="stock_pid" placeholder="Ex: 10" />
                </div>
                <div style="width:160px">
                  <label class="small muted">Nouveau stock</label>
                  <input id="stock_value" type="number" step="1" placeholder="Ex: 0" />
                </div>
                <div style="width:160px">
                  <label class="small muted">&nbsp;</label>
                  <button class="btn warn" id="setStockBtn" type="button">Mettre</button>
                </div>
              </div>

              <div class="muted small" style="margin-top:8px">
                Note: si Stock = 0 ‚Üí le produit ne sort pas c√¥t√© client (ton API getProducts filtre d√©j√†).
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PLACE ORDER -->
      <section id="tab-place" style="display:none">
        <div id="deliveryWarn" class="noteBar">Zone de livraison obligatoire</div>

        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <b>Menu (stock > 0)</b>
              <div class="row">
                <button class="btn" type="button" id="reloadMenuBtn">Recharger</button>
              </div>
            </div>
            <div class="content">
              <input id="menuSearch" placeholder="Recherche‚Ä¶" />
              <div class="hr"></div>
              <div id="menuBox" class="muted">Chargement‚Ä¶</div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Panier (vente)</b>
              <button class="btn bad" type="button" id="clearPlaceCartBtn">Vider</button>
            </div>
            <div class="content">
              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Nom</label>
                  <input id="p_name" placeholder="Ex: Client comptoir" />
                </div>
                <div style="flex:1">
                  <label>T√©l√©phone</label>
                  <input id="p_phone" placeholder="Ex: +509..." />
                </div>
              </div>

              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Type de commande</label>
                  <select id="p_type">
                    <option>Sur place</option>
                    <option>√Ä emporter</option>
                    <option>Livraison</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label>Paiement (obligatoire)</label>
                  <select id="p_pay">
                    <option value="">Choisir‚Ä¶</option>
                    <option value="Cash">Cash</option>
                    <option value="Moncash">Moncash</option>
                    <option value="Natcash">Natcash</option>
                    <option value="Cr√©dit">Cr√©dit</option>
                  </select>
                </div>
              </div>

              <div id="p_delWrap" style="display:none;margin-bottom:10px">
                <label>Zone de livraison</label>
                <select id="p_zone">
                  <option value="">Choisir la zone‚Ä¶</option>
                  <option value="Centre ville Madeline">Centre ville Madeline ‚Äî 250.00 HTG</option>
                  <option value="Centre ville -Barri√®re Bouteille">Centre ville -Barri√®re Bouteille ‚Äî 250.00 HTG</option>
                  <option value="Centre ville - Haut du Cap">Centre ville - Haut du Cap ‚Äî 350.00 HTG</option>
                  <option value="Centre ville- Quartier Morin">Centre ville- Quartier Morin ‚Äî 350.00 HTG</option>
                  <option value="Centre ville - Morne rouge">Centre ville - Morne rouge ‚Äî 500.00 HTG</option>
                  <option value="Centre ville - Limonade">Centre ville - Limonade ‚Äî 500.00 HTG</option>
                </select>

                <div style="height:10px"></div>
                <label>Adresse (livraison)</label>
                <textarea id="p_addr" placeholder="Adresse‚Ä¶"></textarea>
              </div>

              <label>Note (optionnel)</label>
              <textarea id="p_note" placeholder="Ex: sans piment‚Ä¶"></textarea>

              <div class="hr"></div>
              <div id="placeCartItems" class="muted">Panier vide</div>

              <div class="hr"></div>

              <div class="row sp">
                <div>
                  <b>Total</b>
                  <div class="muted small" id="placeFeesInfo" style="margin-top:2px"></div>
                </div>
                <b id="placeTotal">0.00 HTG</b>
              </div>

              <div style="margin-top:12px">
<div class="row" style="gap:10px">
  <button class="btn warn" type="button" id="placePendingBtn">Unregister / En attente</button>
  <button class="btn good" type="button" id="placeOrderBtn" disabled>Enregistrer (Sheets)</button>
</div>              </div>
            </div>
          </div>
        </div>
      </section>
      
<!-- ‚úÖ CLOSE DAY -->
<section id="tab-closeDay" style="display:none">
  <div class="grid">
    <div class="card">
      <div class="cardHead">
        <b>Cl√¥ture de la journ√©e (Preview)</b>
        <div class="row">
  <input id="cd_start" type="date" style="max-width:190px">
  <input id="cd_end" type="date" style="max-width:190px">
  <input id="cd_opening" type="number" step="0.01" placeholder="Encaisse d√©but (HTG)" style="max-width:220px">

  <button class="btn warn" id="cd_previewBtn" type="button">Fermer la journ√©e (Preview)</button>

  <button class="btn good" id="cd_validateBtn" type="button" disabled>Valider (Final + PDF)</button>

  <span id="cd_blockMsg" style="display:none;font-weight:900;color:#ff6b6b;margin-left:10px">
    Commande non livr√©e rest√©e ouverte
  </span>
</div>

      </div>
      <div class="content">
        <div class="muted small">
          Les commandes <b>Annul√©e</b> ne sont pas compt√©es comme ventes.
        </div>
        <div class="hr"></div>

        <div id="cd_summary" class="muted">Aucun preview.</div>

        <div class="hr"></div>

        <b>Ventes par produit</b>
        <div class="content" style="padding:0">
          <table>
            <thead>
              <tr>
                <th>Produit</th>
                <th>Qt√©</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="cd_prodTbody">
              <tr><td colspan="3" class="muted">‚Äî</td></tr>
            </tbody>
          </table>
        </div>

        <div class="hr"></div>

        <div id="cd_pdfBox" class="muted small" style="display:none"></div>
      </div>
    </div>
  </div>
</section>

<!-- ‚úÖ HISTORIQUE TRANSACTIONS -->
<section id="tab-histTx" style="display:none">
  <div class="card">
    <div class="cardHead">
      <b>Historique des transactions</b>
      <div class="row">
        <input id="ht_start" type="date" style="max-width:190px">
        <input id="ht_end" type="date" style="max-width:190px">
        <input id="ht_q" placeholder="Recherche: ID / Tel / Nom..." style="max-width:260px">
        <button class="btn" id="ht_loadBtn" type="button">Rechercher</button>
      </div>
    </div>
    <div class="content" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>ID</th>
            <th>Client</th>
            <th>Paiement</th>
            <th>Total</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody id="ht_tbody">
          <tr><td colspan="6" class="muted">Aucun r√©sultat.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- ‚úÖ HISTORIQUE RAPPORTS -->
<section id="tab-histRep" style="display:none">
  <div class="card">
    <div class="cardHead">
      <b>Historique des rapports (PDF)</b>
      <div class="row">
        <button class="btn" id="hr_loadBtn" type="button">Charger</button>
        <input id="hr_start" type="date" style="max-width:190px">
      <input id="hr_end" type="date" style="max-width:190px">
     </div>
    </div>
    <div class="content" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Cr√©√©</th>
            <th>Encaisse d√©but</th>
            <th>Encaisse comptable</th>
            <th>Total</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody id="hr_tbody">
          <tr><td colspan="6" class="muted">Aucun rapport.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>      

    </div>
  </div>
</div>

<script>
/***************
 * CONFIG
 ***************/
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec";
const DEFAULT_COUNTRY_CODE = "509";
const DEFAULT_ADMIN_KEY = "bes_admin_06070048094439";
const LS_ADMIN_KEY = "bes_admin_key";

/***************
 * Livraison: frais par zone
 ***************/
const DELIVERY_FEES = {
  "Centre ville Madeline": 250,
  "Centre ville -Barri√®re Bouteille": 250,
  "Centre ville - Haut du Cap": 350,
  "Centre ville- Quartier Morin": 350,
  "Centre ville - Morne rouge": 500,
  "Centre ville - Limonade": 500,
};

function getDeliveryFee(){
  const isLiv = norm($("p_type").value)==="livraison";
  if(!isLiv) return 0;
  const z = $("p_zone").value.trim();
  return Number(DELIVERY_FEES[z] || 0);
}

/***************
 * JSONP helper
 ***************/
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    if(!API_URL){
      reject(new Error("API_URL manquant."));
      return;
    }
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const url = API_URL + "?" + q;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;

    let done = false;
    const timer = setTimeout(()=> {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout API"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch(e){}
      try { s.remove(); } catch(e){}
    }

    window[cb] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("API error"));
    };

    document.head.appendChild(s);
  });
}

/***************
 * UI helpers
 ***************/
const $ = (id)=>document.getElementById(id);

function toast(msg){
  $("toast").style.display="block";
  $("toast").textContent=String(msg||"");
  setTimeout(()=>{$("toast").style.display="none";}, 3500);
}
function showErr(msg){
  $("err").style.display="block";
  $("err").textContent=String(msg||"Erreur");
  setTimeout(()=>{$("err").style.display="none";}, 6500);
}
function fmtHTG(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}) + " HTG";
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function norm(s){ return String(s||"").toLowerCase().trim(); }
  
let _pendingFinalizeOrderId = null;

function openPayModal(orderId, defaultPay=""){
  _pendingFinalizeOrderId = orderId;
  $("paySelect").value = defaultPay || "";
  $("payModal").style.display = "flex";
}

function closePayModal(){
  _pendingFinalizeOrderId = null;
  $("payModal").style.display = "none";
}

async function confirmPayModal(){
  const pay = $("paySelect").value;
  if(!pay){
    showErr("Choisis une m√©thode de paiement.");
    return;
  }

  const oid = _pendingFinalizeOrderId;   // ‚úÖ garde l‚ÄôID
  closePayModal();                      // ‚úÖ maintenant on peut fermer
  await finalizePendingWithPay(oid, pay);
}


  
/***************
 * Admin key auto
 ***************/
function getAdminKey(){
  const saved = localStorage.getItem(LS_ADMIN_KEY);
  return (saved && saved.trim()) ? saved.trim() : DEFAULT_ADMIN_KEY;
}
function setAdminKey(v){
  localStorage.setItem(LS_ADMIN_KEY, String(v||"").trim());
}

/***************
 * WhatsApp helpers (CLIENT)
 ***************/
function digitsOnlyPhone(raw){
  let d = String(raw||"").replace(/\D/g,"");
  if(d.length === 8) d = DEFAULT_COUNTRY_CODE + d;
  return d;
}
function openWhatsAppToClient(phone, message){
  const p = digitsOnlyPhone(phone);
  if(!p){
    showErr("T√©l√©phone client invalide.");
    return;
  }
  const url = "https://wa.me/" + p + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

/***************
 * Tabs
 ***************/
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    $("tab-orders").style.display   = (tab==="orders") ? "block" : "none";
    $("tab-pending").style.display = (tab==="pending") ? "block" : "none";
    $("tab-products").style.display = (tab==="products") ? "block" : "none";
    $("tab-place").style.display    = (tab==="place") ? "block" : "none";
    $("tab-closeDay").style.display  = (tab==="closeDay") ? "block" : "none";
    $("tab-histTx").style.display    = (tab==="histTx") ? "block" : "none";
    $("tab-histRep").style.display   = (tab==="histRep") ? "block" : "none";

    if(tab==="orders") loadOrders();
    if(tab==="pending") loadPendingOrders();
    if(tab==="products") { loadCategories(); loadProducts(); }
    if(tab==="place") loadMenuForPlace();    
    if(tab==="closeDay") initCloseDayUI();
    if(tab==="histTx") loadTxHistory();
    if(tab==="histRep") loadReportsHistory();
  });
});

$("refreshBtn").addEventListener("click", ()=>{
  const active = document.querySelector(".tab.active")?.dataset?.tab || "orders";
  if(active==="orders") loadOrders();
  if(active==="pending") loadPendingOrders();
  if(active==="products") { loadCategories(); loadProducts(); }
  if(active==="place") loadMenuForPlace();
  if(active==="closeDay") initCloseDayUI();
  if(active==="histTx") loadTxHistory();
  if(active==="histRep") loadReportsHistory();
});
$("statusFilter").addEventListener("change", loadOrders);

/* ‚úÖ Recherche ID + Masquer livr√©s (filtre local instant) */
$("orderIdSearch").addEventListener("input", ()=> renderOrdersTable(lastOrdersCache));
$("hideDelivered").addEventListener("change", ()=> renderOrdersTable(lastOrdersCache));

/***************
 * Orders (tri + livr√©)
 ***************/
let prevOrderIds = new Set();
let lastOrdersCache = [];
let lastPendingCache = [];
let _editingPendingId = null;
 

function rowClassForStatus(status){
  const st = norm(status);
  if(st.includes("annul")) return "is-cancel";
  if(st.includes("pr√™t") || st.includes("pret")) return "is-working";
  if(st.includes("re√ß") || st.includes("recu") || st.includes("re√ßue")) return "is-received";
  return "";
}

/* ‚úÖ tri : non-livr√© en haut, livr√© en bas, puis date desc */
function sortOrdersForDisplay(list){
  const clone = [...(list||[])];
  clone.sort((a,b)=>{
const aDelivered = norm(a.Statut).includes("livr");
const bDelivered = norm(b.Statut).includes("livr");

    if(aDelivered !== bDelivered) return aDelivered ? 1 : -1; // livr√© => bas
    return String(b.DateHeure||"").localeCompare(String(a.DateHeure||""));
  });
  return clone;
}

/* ‚úÖ filtre : recherche ID + masquer livr√©s */
function filterOrders(list){
  const q = String($("orderIdSearch").value||"").trim();
  const hideDel = !!$("hideDelivered").checked;

  return (list||[]).filter(o=>{
    const st = norm(o.Statut||"");

    if(st.includes("en attente")) return false;
    if(st.includes("annul")) return false;          // ‚úÖ cache les annul√©es
    if(hideDel && st.includes("livr")) return false;
    if(q && !String(o.OrderID||"").includes(q)) return false;

    return true;
  });
}

/***********************
 * üî∂ PENDING ORDERS (En attente)
 ***********************/
async function loadPendingOrders(){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_listOrders", { k, limit:"200", status:"En attente" });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur chargement En attente");

    const list = Array.isArray(r.orders) ? r.orders : [];
    lastPendingCache = list;
    renderPendingTable(list);

  }catch(e){
    showErr(e.message || e);
    $("pendingTbody").innerHTML = `<tr><td colspan="5" class="muted">Erreur.</td></tr>`;
  }
}

function renderPendingTable(list){
  $("pendingTbody").innerHTML = list.length
    ? list.map(o=>{
        const oid = String(o.OrderID||"").trim();
        return `
          <tr>
            <td>${escapeHtml(o.DateHeure||"")}</td>
            <td class="idCell" title="${escapeHtml(oid)}">${escapeHtml(oid)}</td>
            <td>
              <b>${escapeHtml(o.ClientNom||"")}</b>
              <div class="muted">${escapeHtml(o.Telephone||"")}</div>
            </td>
            <td><b>${fmtHTG(o.Total||0)}</b></td>
            <td>
              <div class="actions">
                <button class="btn warn" type="button" onclick="editPending('${oid.replace(/'/g,"")}')">Modifier</button>
                <button class="btn good" type="button" onclick="finalizePending('${oid.replace(/'/g,"")}')">Finaliser</button>
               <button class="btn bad" type="button" onclick="cancelOrder('${oid.replace(/'/g,"")}')">Annuler</button>

              </div>
            </td>
          </tr>
        `;
      }).join("")
    : `<tr><td colspan="5" class="muted">Aucune en attente.</td></tr>`;
}

async function loadOrders(){
  try{
    const k = $("adminKey").value.trim();
    const status = $("statusFilter").value.trim();

    const r = await apiJsonp("admin_listOrders", { k, limit:"200", status });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listOrders");

    const orders = Array.isArray(r.orders) ? r.orders : [];
    lastOrdersCache = orders;

    renderOrdersTable(orders);

  }catch(e){
    showErr(e.message || e);
    $("ordersTbody").innerHTML = `<tr><td colspan="9" class="muted">Erreur de chargement.</td></tr>`;
  }
}

function renderOrdersTable(ordersRaw){
  const tb = $("ordersTbody");

  let orders = filterOrders(ordersRaw);
  orders = sortOrdersForDisplay(orders);

  if(orders.length===0){
    tb.innerHTML = `<tr><td colspan="9" class="muted">Aucune commande.</td></tr>`;
    prevOrderIds = new Set();
    return;
  }

  const currentIds = new Set(orders.map(o=>String(o.OrderID||"").trim()).filter(Boolean));

  tb.innerHTML = orders.map(o=>{
    const type = o.TypeCommande || "";
    const isSurPlace = /sur\s*place/i.test(type);
    const isEmporter = /(√†|a)\s*emporter/i.test(type);

    const st = (o.Statut || "-");
    const badgeClass =
      /annul/i.test(st) ? "badge bad" :
      /livr√©/i.test(st) ? "badge good" :
      /pr√™t|pret/i.test(st) ? "badge good" :
      /re√ß|recu/i.test(st) ? "badge warn" : "badge";

    const safeOrderJson = JSON.stringify(o).replace(/</g,"\\u003c");
    const oid = String(o.OrderID||"").trim();

    const isNew = (!prevOrderIds.has(oid)) && (/re√ß|recu/i.test(st));
    const trClass = (isNew ? "is-new " : "") + rowClassForStatus(st);

   const deliveredChecked = norm(st).includes("livr");

    return `
      <tr class="${trClass}">
        <td>${escapeHtml(o.DateHeure || "")}</td>
        <td class="idCell" title="${escapeHtml(oid)}">${escapeHtml(oid)}</td>
        <td><b>${escapeHtml(o.ClientNom || "")}</b><div class="muted">${escapeHtml(o.Telephone || "")}</div></td>
        <td>${escapeHtml(type)}</td>
        <td>${escapeHtml((o.ResumeItems||"") + "")}</td>
        <td><b>${fmtHTG(o.Total||0)}</b></td>
        <td><span class="${badgeClass}">${escapeHtml(st)}</span></td>
        <td>
          <label class="deliveredBox">
            <input type="checkbox" ${deliveredChecked ? "checked" : ""} onchange="toggleDelivered('${oid.replace(/'/g,"")}', this.checked)">
            Livr√©
          </label>
        </td>
        <td>
          <div class="actions">
            ${isSurPlace ? `
              <button class="btn good" type="button" onclick='readyConsume(${safeOrderJson})'>Pr√™t √† consommer</button>
            ` : ``}

            ${isEmporter ? `
              <button class="btn good" type="button" onclick='readyTakeaway(${safeOrderJson})'>Pr√™t √† emporter</button>
            ` : ``}

            ${/livraison/i.test(type) ? `
              <button class="btn good" type="button" onclick='readyDeliver(${safeOrderJson})'>Pr√™t √† livrer</button>
            ` : ``}

            <button class="btn" type="button" onclick='printPOS80(${safeOrderJson})'>Imprimer 80mm</button>

            <button class="btn bad" type="button" onclick="cancelOrder('${oid.replace(/'/g,"")}')">Annuler</button>

          </div>
        </td>
      </tr>
    `;
  }).join("");

  prevOrderIds = currentIds;
}

/* ‚úÖ coche livr√© => statut Livr√© ; d√©coche => Re√ßue */
window.toggleDelivered = async function(orderId, isDelivered){
  try{
    const nextStatus = isDelivered ? "Livr√©" : "Re√ßue";
    await setStatus(orderId, nextStatus);
    toast(isDelivered ? "Marqu√© livr√© ‚úÖ" : "Remis en Re√ßue ‚úÖ");
    loadOrders(); // re-tri + re-filtre
  }catch(e){
    showErr(e.message || e);
  }
};

window.setStatus = async function(orderId, status){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_setOrderStatus", { k, orderId, status });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_setOrderStatus");
  }catch(e){
    showErr(e.message || e);
    throw e;
  }
};
 // ‚úÖ Annuler une commande (fonction manquante)
window.cancelOrder = async function(orderId){
  try{
    const oid = String(orderId || "").trim();
    if(!oid) throw new Error("OrderID manquant");

    if(!confirm("Annuler cette commande ?")) return;

    await setStatus(oid, "Annul√©e");
    toast("Commande annul√©e ‚úÖ");

    // refresh tables
    loadOrders();
    loadPendingOrders();
  }catch(e){
    showErr(e.message || e);
  }
};
 
function switchTab(tab){
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");

  $("tab-orders").style.display   = (tab==="orders") ? "block" : "none";
  $("tab-pending").style.display  = (tab==="pending") ? "block" : "none";
  $("tab-products").style.display = (tab==="products") ? "block" : "none";
  $("tab-place").style.display    = (tab==="place") ? "block" : "none";
  $("tab-closeDay").style.display = (tab==="closeDay") ? "block" : "none";
  $("tab-histTx").style.display   = (tab==="histTx") ? "block" : "none";
  $("tab-histRep").style.display  = (tab==="histRep") ? "block" : "none";
}

window.editPending = async function(orderId){
  try{
    _editingPendingId = String(orderId || "").trim();
    // ‚úÖ RESET avant de charger une autre commande
    for(const k of Object.keys(placeCart)) delete placeCart[k];
    $("p_name").value = "";
    $("p_phone").value = "";
    $("p_type").value = "Sur place";
    $("p_pay").value = "";
    $("p_note").value = "";
    $("p_zone").value = "";
    $("p_addr").value = "";

    const o = lastPendingCache.find(x=>String(x.OrderID||"").trim()===String(orderId).trim());

    switchTab("place");
    await loadMenuForPlace();

    if(o){
      $("p_name").value  = String(o.ClientNom || "");
      $("p_phone").value = String(o.Telephone || "");
      if(o.TypeCommande) $("p_type").value = o.TypeCommande;
      if(o.NoteCommande) $("p_note").value = o.NoteCommande;

      if(o.Adresse){
        const adr = String(o.Adresse);
        const parts = adr.split("‚Äî").map(s=>s.trim());
        if(parts.length>=2){
          $("p_zone").value = parts[0];
          $("p_addr").value = parts.slice(1).join(" ‚Äî ");
        }else{
          $("p_addr").value = adr;
        }
      }

      if(Array.isArray(o.items) && o.items.length){
        o.items.forEach(it=>{
          const pid = String(it.ProductID);
          const q = Number(it.Quantite||0);
          if(pid && q>0) placeCart[pid] = q;
        });
      }
    }

    syncPlaceDeliveryUI();
    renderPlaceCart();
    validatePlaceOrderBtn();

  }catch(e){
    showErr(e.message || e);
  }
};


function askPaymentMethod(defaultVal=""){
  const opts = ["Cash","Moncash","Natcash","Cr√©dit"];
  const msg = "M√©thode de paiement ?\n" + opts.map((x,i)=>`${i+1}) ${x}`).join("\n");
  const v = prompt(msg, defaultVal ? `Ex: ${defaultVal}` : "Tape: Cash / Moncash / Natcash / Cr√©dit");
  const m = String(v||"").trim();
  if(!m) return null;

  // normalise
  const found = opts.find(x=>x.toLowerCase()===m.toLowerCase());
  return found || m; // accepte texte exact si tu pr√©f√®res
}

window.finalizePending = function(orderId){
  const o = lastPendingCache.find(x=>String(x.OrderID)===String(orderId));
  const existingPay = o?.PaymentMethod || "";
  openPayModal(orderId, existingPay);
};

async function finalizePendingWithPay(orderId, pay){
  try{
    const k = $("adminKey").value.trim();
    let ok = false;

    try{
      const r = await apiJsonp("admin_finalizePendingOrder", {
        k, orderId, paymentMethod: pay
      });
      if(r && r.ok) ok = true;
    }catch(_e){}

    if(!ok){
      await setStatus(orderId, "Re√ßue");
      toast("Finalis√© ‚úÖ (paiement non stock√© c√¥t√© serveur)");
    }else{
      toast("Finalis√© ‚úÖ");
    }

    loadPendingOrders();
    loadOrders();

  }catch(e){
    showErr(e.message || e);
  }
};

window.readyTakeaway = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Pr√™t √† emporter");
    toast("Statut mis √† jour ‚úÖ");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est pr√™te √† emporter. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

window.readyDeliver = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Pr√™t √† livrer");
    toast("Statut mis √† jour ‚úÖ");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est pr√™te √† livrer. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};
window.readyConsume = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Pr√™t √† consommer");
    toast("Statut mis √† jour ‚úÖ");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est pr√™te √† consommer. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

/***************
 * Print POS 80mm (‚úÖ Livraison conditionnelle)
 ***************/
window.printPOS80 = function(order){
  try{
    const items = Array.isArray(order.items) ? order.items : [];
    const resume = String(order.ResumeItems||"").trim();
    const isLiv = /livraison/i.test(String(order.TypeCommande||""));

    const subTotal = Number(order.SubTotal ?? 0);
    const deliveryFee = Number(order.DeliveryFee ?? 0);

    const rows = items.length
      ? items.map(i=>{
          const name = escapeHtml(i.Nom||"");
          const q = Number(i.Quantite||0);
          const st = fmtHTG(i.SousTotal||0);
          return `<tr><td class="name">${name}</td><td class="qty">${q}</td><td class="amt">${st}</td></tr>`;
        }).join("")
      : `<tr><td colspan="3">${escapeHtml(resume || "-")}</td></tr>`;

    const w = window.open("", "_blank", "width=420,height=820");
    if(!w) { showErr("Popup bloqu√© (impression)."); return; }

    const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>POS 80mm</title>
<style>
@page { size: 80mm auto; margin: 6mm; }
body{ margin:0; padding:0; }
.sheet{
  width: 68mm;          /* 80mm - 6mm - 6mm */
  margin: 0 auto;  
  font-family: Arial, sans-serif;
  margin:0;
  color:#000;
  font-size:16px;
}
h1{ text-align:center; font-size:22px; margin:0 0 4px 0; }
.small{ font-size:15px; }
.hr{ border-top:1px dashed #000; margin:10px 0; }
table{ width:100%; border-collapse:collapse; font-size:14px; }
td{ padding:5px 0; }
td.qty{ width:18mm; text-align:right; font-weight:700; }
td.amt{ width:28mm; text-align:right; font-weight:700; }
.footer{ text-align:center; margin-top:10px; font-size:13px; }

.driverBox{
  margin-top:10px;
  border:2px solid #000;
  padding:8px;
}
.driverTitle{
  font-size:16px;
  font-weight:900;
  text-align:center;
  margin-bottom:6px;
}
.driverLine{
  font-size:16px;
  font-weight:900;
  margin:4px 0;
}
.driverLabel{
  display:inline-block;
  min-width:18mm;
}
</style>
</head>
<body>
<h1>BES FAST FOOD</h1>
<div class="small">
  <div><b>Date:</b> ${escapeHtml(order.DateHeure||"")}</div>
  <div><b>ID:</b> ${escapeHtml(order.OrderID||"")}</div>
  <div><b>Client:</b> ${escapeHtml(order.ClientNom||"")}</div>
  <div><b>T√©l:</b> ${escapeHtml(order.Telephone||"")}</div>
  <div><b>Type:</b> ${escapeHtml(order.TypeCommande||"")}</div>
  ${isLiv && order.Adresse ? `<div><b>Adresse:</b> ${escapeHtml(order.Adresse||"")}</div>` : ``}
</div>

<div class="hr"></div>

<table><tbody>${rows}</tbody></table>

<div class="hr"></div>

${isLiv ? `
  <div class="small"><b>Sous-total:</b> ${fmtHTG(subTotal)}</div>
  <div class="small"><b>Frais livraison:</b> ${fmtHTG(deliveryFee)}</div>
  <div class="small"><b>Total:</b> ${fmtHTG(order.Total||0)}</div>

  <div class="driverBox">
    <div class="driverTitle">R√âSUM√â LIVREUR</div>
    <div class="driverLine"><span class="driverLabel">NOM:</span> ${escapeHtml(order.ClientNom||"")}</div>
    <div class="driverLine"><span class="driverLabel">TEL:</span> ${escapeHtml(order.Telephone||"")}</div>
    <div class="driverLine"><span class="driverLabel">ADR:</span> ${escapeHtml(order.Adresse||"-")}</div>
  </div>
` : `
  <div class="small"><b>Total:</b> ${fmtHTG(order.Total||0)}</div>
`}

<div class="footer small">Merci d'avoir choisi BES Fast Food</div>
<script>window.onload=function(){ window.print(); }<\/script>
</body>
</html>`;

    w.document.open();
    w.document.write(html);
    w.document.close();

  }catch(e){
    showErr("Impression: " + (e.message || e));
  }
};

/***************
 * Products (liste + upsert + cat√©gories + stock)
 ***************/
let productsCache = [];
let categoriesCache = [];

async function loadCategories(){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_listCategories", { k });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listCategories");

    categoriesCache = Array.isArray(r.categories) ? r.categories : [];
    const sel = $("pf_catSelect");
    sel.innerHTML = `<option value="">(Aucune)</option>` + categoriesCache.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  }catch(e){
    categoriesCache = [];
    $("pf_catSelect").innerHTML = `<option value="">(Aucune)</option>`;
  }
}

async function loadProducts(){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_listProducts", { k });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listProducts");

    const list = Array.isArray(r.products) ? r.products : [];
    productsCache = list;

    if(list.length===0){
      $("productsBox").innerHTML = `<div class="muted">Aucun produit.</div>`;
      return;
    }

    const html = list.map(p=>{
      const actif = String(p.Actif || "TRUE").toUpperCase() !== "FALSE";
      const stock = Number(p.Stock || 0);
      const pid = escapeHtml(p.ProductID||"");
      return `
        <div class="prod" style="margin-bottom:10px">
          <div style="min-width:0">
            <b>${escapeHtml(p.Nom||"")}</b>
            <div class="muted">${escapeHtml(p.Categorie||"")}</div>
            <div class="muted">ID: <b>${pid}</b> ‚Ä¢ Prix: <b>${fmtHTG(p.Prix||0)}</b> ‚Ä¢ Stock: <b>${stock}</b> ‚Ä¢ Actif: <b>${actif ? "Oui" : "Non"}</b></div>
            <div class="muted small">Ordre: ${escapeHtml(p.Ordre ?? "")}</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <span class="badge ${stock>0 && actif ? "good":"bad"}">${stock>0 && actif ? "En vente" : "Hors vente"}</span>
            <button class="btn" type="button" onclick="pickProduct('${String(p.ProductID||"").replace(/'/g,"")}')">S√©lectionner</button>
          </div>
        </div>
      `;
    }).join("");

    $("productsBox").innerHTML = html;

  }catch(e){
    showErr(e.message || e);
    $("productsBox").textContent = "Erreur.";
  }
}

window.pickProduct = function(productId){
  const p = productsCache.find(x=>String(x.ProductID)===String(productId));
  if(!p){ showErr("Produit introuvable."); return; }

  $("pf_id").value = String(p.ProductID||"");
  $("pf_name").value = String(p.Nom||"");
  $("pf_price").value = Number(p.Prix||0);
  $("pf_stock").value = Number(p.Stock||0);
  $("pf_order").value = (p.Ordre!==undefined && p.Ordre!==null) ? String(p.Ordre) : "";
  $("pf_active").value = (String(p.Actif||"TRUE").toUpperCase() === "FALSE") ? "FALSE" : "TRUE";
  $("pf_catNew").value = "";
  $("pf_catSelect").value = String(p.Categorie||"");

  $("stock_pid").value = String(p.ProductID||"");
  $("stock_value").value = Number(p.Stock||0);

  toast("Produit s√©lectionn√© ‚úÖ");
};

$("reloadProductsBtn").addEventListener("click", loadProducts);
$("reloadCatsBtn").addEventListener("click", loadCategories);
$("pendingReloadBtn").addEventListener("click", loadPendingOrders);

$("clearFormBtn").addEventListener("click", ()=>{
  ["pf_id","pf_name","pf_catNew","pf_price","pf_stock","pf_order"].forEach(id=>$(id).value="");
  $("pf_catSelect").value="";
  $("pf_active").value="TRUE";
  toast("Formulaire vid√© ‚úÖ");
});

$("fillFromSelectedBtn").addEventListener("click", ()=>{
  const pid = $("pf_id").value.trim();
  if(!pid){ showErr("Mets ProductID d'abord, ou clique S√©lectionner."); return; }
  const p = productsCache.find(x=>String(x.ProductID)===String(pid));
  if(!p){ showErr("Produit introuvable dans la liste."); return; }
  window.pickProduct(pid);
});

$("saveProductBtn").addEventListener("click", async ()=>{
  try{
    const k = $("adminKey").value.trim();
    const ProductID = $("pf_id").value.trim();
    const Nom = $("pf_name").value.trim();
    if(!ProductID) throw new Error("ProductID obligatoire.");
    if(!Nom) throw new Error("Nom obligatoire.");

    const catNew = $("pf_catNew").value.trim();
    const catSel = $("pf_catSelect").value.trim();
    const Categorie = catNew || catSel || "";

    const Prix = Number($("pf_price").value || 0);
    const Stock = Number($("pf_stock").value || 0);
    const Ordre = ($("pf_order").value.trim()==="") ? 9999 : Number($("pf_order").value);
    const Actif = $("pf_active").value;

    const product = { ProductID, Nom, Categorie, Prix, Stock, Ordre, Actif };

    const r = await apiJsonp("admin_upsertProduct", { k, product: JSON.stringify(product) });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_upsertProduct");

    toast("Produit enregistr√© ‚úÖ");
    await loadCategories();
    await loadProducts();

  }catch(e){
    showErr(e.message || e);
  }
});

$("setStockBtn").addEventListener("click", async ()=>{
  try{
    const k = $("adminKey").value.trim();
    const productId = $("stock_pid").value.trim();
    const stock = $("stock_value").value;
    if(!productId) throw new Error("ProductID manquant.");
    if(stock === "" || stock === null || stock === undefined) throw new Error("Stock manquant.");

    const r = await apiJsonp("admin_updateStock", { k, productId, stock: String(stock) });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_updateStock");

    toast("Stock mis √† jour ‚úÖ");
    loadProducts();
  }catch(e){
    showErr(e.message || e);
  }
});

/***************
 * Place order (submitOrderLite + getProducts)
 ***************/
let menuProducts = [];
const placeCart = {}; // { productId: qty }

function syncPlaceDeliveryUI(){
  const isLiv = norm($("p_type").value)==="livraison";
  $("p_delWrap").style.display = isLiv ? "block" : "none";
  $("deliveryWarn").style.display = "none";

  if(!isLiv){
    $("p_zone").value="";
    $("p_addr").value="";
  }
  renderPlaceCart();
}

function calcPlaceSubtotal(){
  let total = 0;
  for(const [pid, qty] of Object.entries(placeCart)){
    const p = menuProducts.find(x=>String(x.ProductID)===String(pid));
    if(!p) continue;
    total += Number(p.Prix||0) * Number(qty||0);
  }
  return total;
}

function calcPlaceTotal(){
  return calcPlaceSubtotal() + getDeliveryFee();
}

function renderPlaceCart(){
  const entries = Object.entries(placeCart);

  const fee = getDeliveryFee();
  const isLiv = norm($("p_type").value)==="livraison";
  $("placeFeesInfo").textContent = isLiv
    ? (fee > 0 ? `Frais livraison: ${fmtHTG(fee)}` : "Frais livraison: (choisis une zone)")
    : "";

  $("placeTotal").textContent = fmtHTG(calcPlaceTotal());

  if(entries.length===0){
    $("placeCartItems").innerHTML = `<div class="muted">Panier vide</div>`;
  }else{
    $("placeCartItems").innerHTML = entries.map(([pid, qty])=>{
      const p = menuProducts.find(x=>String(x.ProductID)===String(pid));
      const name = p ? p.Nom : ("Produit " + pid);
      const sub = (p ? Number(p.Prix||0) : 0) * Number(qty||0);
      return `
        <div class="row sp" style="margin:6px 0">
          <div style="min-width:0">
            <b>${escapeHtml(name)}</b>
            <div class="muted">${fmtHTG(p?.Prix||0)} √ó ${qty} = <b>${fmtHTG(sub)}</b></div>
          </div>
          <div class="row" style="gap:6px">
            <button class="mini" type="button" onclick="placeQty('${pid}', ${Number(qty)-1})">‚àí</button>
            <button class="mini" type="button" onclick="placeQty('${pid}', ${Number(qty)+1})">+</button>
            <button class="mini" type="button" onclick="placeRm('${pid}')">x</button>
          </div>
        </div>
      `;
    }).join("");

    if(isLiv){
      const z = $("p_zone").value.trim();
      const f = fee;
      $("placeCartItems").innerHTML += `
        <div class="hr"></div>
        <div class="row sp">
          <div>
            <b>Frais livraison</b>
            <div class="muted small">${escapeHtml(z || "Zone non choisie")}</div>
          </div>
          <b>${fmtHTG(f)}</b>
        </div>
      `;
    }
  }

  validatePlaceOrderBtn();
}

window.placeQty = function(pid, q){
  const next = Number(q||0);
  if(next <= 0) delete placeCart[pid];
  else placeCart[pid] = next;
  renderPlaceCart();
};
window.placeRm = function(pid){
  delete placeCart[pid];
  renderPlaceCart();
};
window.placeAdd = function(pid){
  placeCart[String(pid)] = (Number(placeCart[String(pid)]||0) + 1);
  renderPlaceCart();
};

function validatePlaceOrderBtn(){
  const itemsCount = Object.keys(placeCart).length;
  const nameOk = !!$("p_name").value.trim();
  const phoneOk = !!$("p_phone").value.trim();
  const payOk = !!$("p_pay").value.trim();

  const isLiv = norm($("p_type").value)==="livraison";
  const zoneOk = !isLiv || !!$("p_zone").value.trim();
  const addrOk = !isLiv || !!$("p_addr").value.trim();

  $("placeOrderBtn").disabled = !(itemsCount>0 && nameOk && phoneOk && payOk && zoneOk && addrOk);
}

function renderMenu(){
  const q = norm($("menuSearch").value);
  const list = menuProducts.filter(p=>{
    const hay = norm(p.Nom) + " " + norm(p.Categorie);
    return !q || hay.includes(q);
  });

  if(list.length===0){
    $("menuBox").innerHTML = `<div class="muted">Aucun produit trouv√©.</div>`;
    return;
  }

  $("menuBox").innerHTML = `
    <div class="menuGrid">
      ${list.map(p=>{
        return `
          <div class="prod">
            <div style="min-width:0">
              <b>${escapeHtml(p.Nom||"")}</b>
              <div class="muted">${escapeHtml(p.Categorie||"")}</div>
              <div class="muted">Prix: <b>${fmtHTG(p.Prix||0)}</b> ‚Ä¢ Stock: ${escapeHtml(p.Stock||"")}</div>
            </div>
            <div>
              <button class="btn good" type="button" onclick="placeAdd('${String(p.ProductID).replace(/'/g,"")}')">Ajouter</button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

async function loadMenuForPlace(){
  try{
    const r = await apiJsonp("getProducts", {});
    if(!r || !r.ok) throw new Error(r?.error || "Erreur getProducts");
    menuProducts = Array.isArray(r.products) ? r.products : [];
    renderMenu();
    renderPlaceCart();
  }catch(e){
    showErr(e.message || e);
    $("menuBox").textContent = "Erreur menu.";
  }
}

$("menuSearch").addEventListener("input", renderMenu);
$("reloadMenuBtn").addEventListener("click", loadMenuForPlace);

$("p_type").addEventListener("change", ()=>{ syncPlaceDeliveryUI(); validatePlaceOrderBtn(); });
$("p_zone").addEventListener("change", ()=>{ renderPlaceCart(); validatePlaceOrderBtn(); });

["p_name","p_phone","p_addr","p_note"].forEach(id=>{
  document.getElementById(id).addEventListener("input", validatePlaceOrderBtn);
});
$("p_pay").addEventListener("change", validatePlaceOrderBtn);

$("clearPlaceCartBtn").addEventListener("click", ()=>{
  for(const k of Object.keys(placeCart)) delete placeCart[k];
  renderPlaceCart();
  toast("Panier vid√© ‚úÖ");
});
$("placePendingBtn").addEventListener("click", async ()=>{
  try{
    const k = $("adminKey").value.trim();

    const items = Object.entries(placeCart).map(([ProductID, Quantite])=>({ ProductID, Quantite }));
    if(items.length===0) throw new Error("Panier vide");

    const typeCommande = $("p_type").value;
    const isLiv = norm(typeCommande)==="livraison";
    if(!$("p_name").value.trim()) throw new Error("Nom obligatoire.");

    const zone = $("p_zone").value.trim();
    const addr = $("p_addr").value.trim();

    if(isLiv && !zone) throw new Error("Zone de livraison obligatoire.");
    if(isLiv && !addr) throw new Error("Adresse obligatoire.");

    const fee = getDeliveryFee();
    const sub = calcPlaceSubtotal();
    const total = sub + fee;

    const baseNote = $("p_note").value.trim();
    const deliveryNote = isLiv ? `Zone: ${zone} | Frais livraison: ${fmtHTG(fee)}` : "";
    const noteCommande = [baseNote, deliveryNote].filter(Boolean).join(" | ");

    const payload = {
      guestId: "admin-pos",
      clientNom: $("p_name").value.trim(),
      telephone: $("p_phone").value.trim(),
      typeCommande,
      adresse: isLiv ? `${zone} ‚Äî ${addr}` : "",
      noteCommande,
      paymentMethod: $("p_pay").value.trim() || "",
      items,
      deliveryZone: isLiv ? zone : "",
      deliveryFee: isLiv ? fee : 0,
      totalOverride: total
    };

    // ‚úÖ 1) Cr√©e la nouvelle commande en attente (UNE SEULE FOIS)
    const r = await apiJsonp("admin_createPendingOrder", { k, payload: JSON.stringify(payload) });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_createPendingOrder");

    // ‚úÖ 2) Si on modifiait une ancienne commande, on annule l‚Äôancienne APR√àS succ√®s
    if(_editingPendingId){
      await setStatus(_editingPendingId, "Annul√©e");
    }
    _editingPendingId = null;

    // ‚úÖ 3) UI refresh (UNE SEULE FOIS)
    toast("Commande mise en attente ‚úÖ ID: " + (r.orderId || "OK"));
    loadPendingOrders();
    switchTab("pending");

    // reset panier / champs
    for(const k2 of Object.keys(placeCart)) delete placeCart[k2];
    $("p_note").value="";
    $("p_addr").value="";
    $("p_zone").value="";
    $("p_type").value="Sur place";
    $("p_pay").value="";
    $("deliveryWarn").style.display="none";

    syncPlaceDeliveryUI();
    renderPlaceCart();

    loadMenuForPlace();
    loadOrders();

  }catch(e){
    showErr(e.message || e);
  }
});


$("placeOrderBtn").addEventListener("click", async ()=>{
  try{
    const items = Object.entries(placeCart).map(([ProductID, Quantite])=>({ ProductID, Quantite }));
    if(items.length===0) throw new Error("Panier vide");

    const typeCommande = $("p_type").value;
    const isLiv = norm(typeCommande)==="livraison";

    if(isLiv){
      const z = $("p_zone").value.trim();
      if(!z){
        $("deliveryWarn").style.display = "block";
        throw new Error("Zone de livraison obligatoire.");
      }
      const addr = $("p_addr").value.trim();
      if(!addr){
        $("deliveryWarn").style.display = "block";
        throw new Error("Adresse obligatoire.");
      }
    }

    const fee = getDeliveryFee();
    const sub = calcPlaceSubtotal();
    const total = sub + fee;

    const baseNote = $("p_note").value.trim();
    const zone = $("p_zone").value.trim();
    const deliveryNote = isLiv ? `Zone: ${zone} | Frais livraison: ${fmtHTG(fee)}` : "";
    const noteCommande = [baseNote, deliveryNote].filter(Boolean).join(" | ");

    const payload = {
      guestId: "admin-pos",
      clientNom: $("p_name").value.trim(),
      telephone: $("p_phone").value.trim(),
      typeCommande,
      adresse: isLiv ? `${zone} ‚Äî ${$("p_addr").value.trim()}` : "",
      noteCommande,
      paymentMethod: $("p_pay").value.trim(),
      items,
      deliveryZone: isLiv ? zone : "",
      deliveryFee: isLiv ? fee : 0,
      totalOverride: total
    };

    const r = await apiJsonp("submitOrderLite", { payload: JSON.stringify(payload) });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur submitOrderLite");

    toast("Commande enregistr√©e ‚úÖ ID: " + (r.orderId || "OK"));

    for(const k of Object.keys(placeCart)) delete placeCart[k];
    $("p_note").value="";
    $("p_addr").value="";
    $("p_zone").value="";
    $("p_type").value="Sur place";
    $("p_pay").value="";
    $("deliveryWarn").style.display="none";

    syncPlaceDeliveryUI();
    renderPlaceCart();

    loadMenuForPlace();
    loadOrders();

  }catch(e){
    showErr(e.message || e);
  }
});

/***************
 * Boot
 ***************/
(function(){
  const k = getAdminKey();
  $("adminKey").value = k;
  setAdminKey(k);

  $("adminKey").addEventListener("input", ()=>{
    setAdminKey($("adminKey").value.trim());
  });

  syncPlaceDeliveryUI();
  loadOrders();
  })(); // fin Boot

/****************
 * Close Day
 ****************/
let _cd_lastPreview = null;


function todayISO(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}

function initCloseDayUI(){
  if(!$("cd_start").value) $("cd_start").value = todayISO();
  if(!$("cd_end").value) $("cd_end").value = todayISO();
  if($("cd_opening").value==="") $("cd_opening").value = "0";
  $("cd_validateBtn").disabled = true;
  $("cd_pdfBox").style.display="none";
  if($("cd_blockMsg")) $("cd_blockMsg").style.display="none";
}


async function closeDayPreview(){
  try{
    const k = $("adminKey").value.trim();                 // ‚úÖ d√©fini
    const startDate = $("cd_start").value.trim() || todayISO();
    const endDate   = $("cd_end").value.trim()   || startDate;
    const openingCash = $("cd_opening").value;            // ‚úÖ d√©fini

    const r = await apiJsonp("admin_closeDayPreview", {
      k,
      startDate,
      endDate,
      openingCash: String(openingCash || 0)
    });

    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_closeDayPreview");

    _cd_lastPreview = r;
    renderCloseDayPreview(r);

    // ‚úÖ blocage si non livr√©es
   // ‚úÖ blocage si non livr√©es (avec fallback local)
let und = Number(r.undeliveredCount || 0);

// Fallback si le backend renvoie la liste des commandes
const list = Array.isArray(r.orders) ? r.orders
  : (Array.isArray(r.openOrders) ? r.openOrders : null);

function normStatus(s){
  s = String(s||"").trim().toLowerCase();
  try{
    s = s.normalize("NFD").replace(/[\u0300-\u036f]/g,""); // enl√®ve accents
  }catch(_e){}
  return s;
}

if(list){
  und = list.filter(o=>{
    const st = normStatus(o.Statut || o.status);
    if(!st) return false;
    if(st.includes("annul")) return false;
    if(st.includes("attente")) return false;
    return !st.includes("livr");
  }).length;
}

$("cd_blockMsg").style.display = und > 0 ? "inline" : "none";
$("cd_validateBtn").disabled = und > 0;
    toast("Preview g√©n√©r√© ‚úÖ");
  }catch(e){
    showErr(e.message || e);
  }
}


function renderCloseDayPreview(pv){
  const und = Number(pv.undeliveredCount || 0);

  const undMsg = und > 0
    ? `<div style="
        margin-bottom:10px;
        padding:10px 12px;
        border-radius:12px;
        border:1px solid rgba(255,193,7,.30);
        background: rgba(255,193,7,.12);
        font-weight:900
      ">
        ${und} commande${und>1?'s':''} ne ${und>1?'sont':'est'} pas livr√©e${und>1?'s':''}.
      </div>`
    : "";
  const t = pv.totals || {};
  const pay = (t.byPayment || {});
  const lines = [
    `<b>Date:</b> ${escapeHtml(pv.date || "")}`,
    `<b>Nb ventes:</b> ${Number(pv.ordersCount||0)}`,
    `<b>Ventes paiement:</b>`,
    `Cash: <b>${fmtHTG(pay.Cash||0)}</b> ‚Ä¢ Cr√©dit: <b>${fmtHTG(pay["Cr√©dit"]||0)}</b>`,
    `Moncash: <b>${fmtHTG(pay.Moncash||0)}</b> ‚Ä¢ Natcash: <b>${fmtHTG(pay.Natcash||0)}</b>`,
    `<b>TOTAL:</b> <b>${fmtHTG(t.grandTotal||0)}</b>`,
    `<hr class="hr">`,
    `Encaisse d√©but: <b>${fmtHTG(t.openingCash||0)}</b>`,
    `Ventes Cash: <b>${fmtHTG(pay.Cash||0)}</b>`,
    `<b>Encaisse comptable:</b> <b>${fmtHTG(t.accountingCash||0)}</b>`
  ];
  $("cd_summary").innerHTML = lines.join("<br>");

  const list = Array.isArray(pv.byProduct) ? pv.byProduct : [];
  const itemsTotalLocal = list.reduce((s,x)=> s + Number(x.amount||0), 0);
  $("cd_prodTbody").innerHTML = list.length
    ? list.map(x=>`
        <tr>
          <td>${escapeHtml(x.name||"")}</td>
          <td>${Number(x.qty||0)}</td>
          <td><b>${fmtHTG(x.amount||0)}</b></td>
        </tr>
      `).join("") + `
      <tr>
        <td colspan="2"><b>TOTAL PRODUITS</b></td>
        <td><b>${fmtHTG(itemsTotalLocal)}</b></td>
      </tr>
    `
    : `<tr><td colspan="3" class="muted">Aucun</td></tr>`;
}

async function validateCloseDay(){
  try{
    const k = $("adminKey").value.trim();                 // ‚úÖ d√©fini
    const startDate = $("cd_start").value.trim() || todayISO();
    const endDate   = $("cd_end").value.trim()   || startDate;
    const openingCash = $("cd_opening").value;            // ‚úÖ d√©fini

    // ‚úÖ s√©curit√© : si preview indique non livr√©es => bloquer
    const und = Number(_cd_lastPreview?.undeliveredCount || 0);
    if(und > 0){
      $("cd_blockMsg").style.display = "inline";
      $("cd_validateBtn").disabled = true;
      throw new Error("Impossible de valider : commande(s) non livr√©e(s).");
    }

    const r = await apiJsonp("admin_validateCloseDay", {
      k,
      startDate,
      endDate,
      openingCash: String(openingCash || 0)
    });

    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_validateCloseDay");

    toast("Cl√¥ture valid√©e ‚úÖ (PDF + historique)");
    $("cd_validateBtn").disabled = true;

    if(r.pdfUrl){
      $("cd_pdfBox").style.display="block";
      $("cd_pdfBox").innerHTML = `PDF pr√™t: <a href="${r.pdfUrl}" target="_blank"><b>Ouvrir / Imprimer</b></a>`;
    }

    loadOrders();
  }catch(e){
    showErr(e.message || e);
  }
}

$("cd_previewBtn").addEventListener("click", closeDayPreview);
$("cd_validateBtn").addEventListener("click", validateCloseDay);
async function loadTxHistory(){
  try{
    const k = $("adminKey").value.trim();
   const startDate = $("ht_start").value.trim();
  const endDate = $("ht_end").value.trim();
    const q = $("ht_q").value.trim();

   const r = await apiJsonp("admin_listTransactionsHistory", {
  k, startDate, endDate, q, limit:"200"
});

    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listTransactionsHistory");

    const list = Array.isArray(r.orders) ? r.orders : [];
    list.sort((a,b)=>{
  const da = new Date(a.DateHeure || a.Date || 0).getTime();
  const db = new Date(b.DateHeure || b.Date || 0).getTime();
  return db - da; // plus r√©cent d‚Äôabord
  });
    $("ht_tbody").innerHTML = list.length ? list.map(o=>{
      const st = String(o.Statut||"-");
      return `
        <tr>
          <td>${escapeHtml(String(o.Date||"").slice(0,10) || String(o.DateHeure||""))}</td>
          <td class="idCell" title="${escapeHtml(o.OrderID||"")}">${escapeHtml(o.OrderID||"")}</td>
          <td><b>${escapeHtml(o.ClientNom||"")}</b><div class="muted">${escapeHtml(o.Telephone||"")}</div></td>
          <td>${escapeHtml(o.PaymentMethod||"")}</td>
          <td><b>${fmtHTG(o.Total||0)}</b></td>
          <td>${escapeHtml(st)}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="6" class="muted">Aucun r√©sultat.</td></tr>`;
  }catch(e){
    showErr(e.message || e);
  }
}
$("ht_loadBtn").addEventListener("click", loadTxHistory);

async function loadReportsHistory(){
  try{
    const k = $("adminKey").value.trim();
    const startDate = $("hr_start").value.trim();
    const endDate = $("hr_end").value.trim();
   const r = await apiJsonp("admin_listReportsHistory", { k, startDate, endDate, limit:"120" });

    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listReportsHistory");

    const list = Array.isArray(r.reports) ? r.reports : [];
    list.sort((a,b)=>{
  const da = new Date(a.Date || a.CreatedAt || 0).getTime();
  const db = new Date(b.Date || b.CreatedAt || 0).getTime();
  return db - da; // plus r√©cent d‚Äôabord
  });
    $("hr_tbody").innerHTML = list.length ? list.map(x=>{
      const pdf = String(x.PdfUrl||"").trim();
      const created = String(x.CreatedAt||"");
      return `
        <tr>
          <td>${escapeHtml(x.Date||"")}</td>
          <td class="muted">${escapeHtml(created)}</td>
          <td>${fmtHTG(x.OpeningCash||0)}</td>
          <td><b>${fmtHTG(x.AccountingCash||0)}</b></td>
          <td><b>${fmtHTG(x.GrandTotal||0)}</b></td>
          <td>${pdf ? `<a href="${pdf}" target="_blank"><b>Ouvrir</b></a>` : `<span class="muted">‚Äî</span>`}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="6" class="muted">Aucun rapport.</td></tr>`;

  }catch(e){
    showErr(e.message || e);
  }
}
$("hr_loadBtn").addEventListener("click", loadReportsHistory);

  
</script>

 <!-- ‚úÖ Modal choix paiement (Finaliser) -->
<div id="payModal" style="
  position:fixed; inset:0; display:none; z-index:9999;
  background:rgba(0,0,0,.6); backdrop-filter: blur(6px);
  align-items:center; justify-content:center;
">
  <div style="
    width:360px; max-width:90%;
    background:#0b1220; border:1px solid rgba(255,255,255,.15);
    border-radius:16px; padding:18px; box-shadow:0 12px 32px rgba(0,0,0,.4)
  ">
    <h3 style="margin-top:0">M√©thode de paiement</h3>

    <select id="paySelect" style="width:100%;margin:10px 0">
      <option value="">‚Äî Choisir ‚Äî</option>
      <option value="Cash">Cash</option>
      <option value="Moncash">Moncash</option>
      <option value="Natcash">Natcash</option>
      <option value="Cr√©dit">Cr√©dit</option>
    </select>

    <div class="row" style="justify-content:flex-end;margin-top:14px">
      <button class="btn" onclick="closePayModal()">Annuler</button>
      <button class="btn good" onclick="confirmPayModal()">Valider</button>
    </div>
  </div>
</div>
  
 </body>
</html>


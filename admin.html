<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BES Fast Food ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background:#f6f6f6; }
    h1 { margin: 0 0 10px; }
    nav button { margin: 4px; padding: 10px 14px; border-radius:8px; border:1px solid #bbb; cursor:pointer; background:#fff; }
    nav button.active { background:#111; color:#fff; border-color:#111; }
    section { display:none; background:#fff; padding:12px; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,.06); }
    section.active { display:block; }
    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    .pill { background:#eee; padding:6px 10px; border-radius:999px; font-size:13px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    table { width:100%; border-collapse: collapse; margin-top:10px; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align:top; }
    th { background:#f0f0f0; text-align:left; }
    tr.new { background:#fff3cd; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > div { flex: 1; min-width: 160px; }
    input, select, textarea { padding:8px; width:100%; border:1px solid #ccc; border-radius:8px; }
    button { padding:8px 12px; border:1px solid #bbb; border-radius:8px; cursor:pointer; background:#fff; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.small { padding:6px 10px; font-size:13px; }
    .muted { color:#666; font-size:13px; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; margin-top:10px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:12px; }
    .card h3 { margin:0 0 8px; font-size:15px; }
    .big { font-size:24px; font-weight:700; }
    .toast { position:fixed; right:12px; bottom:12px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; display:none; }
  </style>
</head>
<body>

<h1>üçî BES Fast Food ‚Äì Admin</h1>

<nav>
  <button id="tabOrders" class="active" onclick="showTab('orders')">üì¶ Commandes</button>
  <button id="tabProducts" onclick="showTab('products')">üçü Produits</button>
  <button id="tabDash" onclick="showTab('dash')">üìä Dashboard</button>
</nav>

<div class="bar">
  <span class="pill">Auto-refresh: <b id="autoState">ON</b></span>
  <button class="small" onclick="toggleAuto()">‚è±Ô∏è Toggle</button>
  <button class="small" onclick="testBeep()">üîî Test son</button>
  <span class="muted">Ouvre avec <b>#k=TA_CLE</b></span>
</div>

<section id="orders" class="active">
  <h2>üì¶ Commandes</h2>
  <div class="bar">
    <button class="primary" onclick="loadOrders(true)">üîÑ Rafra√Æchir</button>
    <select id="statusFilter" onchange="loadOrders(true)" style="max-width:220px">
      <option value="">Tous statuts</option>
      <option value="Re√ßue">Re√ßue</option>
      <option value="Pr√™te">Pr√™te</option>
      <option value="Termin√©e">Termin√©e</option>
      <option value="Annul√©e">Annul√©e</option>
    </select>
    <span class="pill">Derni√®re sync: <b id="lastSync">-</b></span>
  </div>
  <div id="ordersMsg"></div>
  <table id="ordersTable"></table>
</section>

<section id="products">
  <h2>üçü Produits</h2>

  <div class="bar">
    <button class="primary" onclick="loadProducts()">üîÑ Charger Produits</button>
    <button onclick="clearForm()">‚ûï Nouveau</button>
    <span id="prodMsg"></span>
  </div>

  <h3>‚ûï Ajouter / Modifier (dropdown √©ditable)</h3>
  <div class="row">
    <div>
      <label class="muted">ProductID</label>
      <input id="pId" placeholder="Ex: P001" list="prodIdList" />
      <datalist id="prodIdList"></datalist>
    </div>
    <div>
      <label class="muted">Nom</label>
      <input id="pName" placeholder="Nom du produit" />
    </div>
    <div>
      <label class="muted">Cat√©gorie (tu peux taper une nouvelle)</label>
      <input id="pCat" placeholder="Ex: Burgers" list="catList" />
      <datalist id="catList"></datalist>
    </div>
    <div>
      <label class="muted">Prix</label>
      <input id="pPrice" type="number" placeholder="Prix" />
    </div>
    <div>
      <label class="muted">Stock</label>
      <input id="pStock" type="number" placeholder="Stock" />
    </div>
  </div>

  <div class="bar">
    <button class="primary" onclick="saveProduct()">üíæ Enregistrer</button>
    <button onclick="deactivateProduct()">üö´ D√©sactiver</button>
  </div>

  <h3>üìã Liste (stock modifiable ‚Äúlite‚Äù)</h3>
  <div class="muted">Clique une ligne pour √©diter. Modifie le stock directement puis ‚ÄúOK‚Äù.</div>
  <table id="productsTable"></table>
</section>

<section id="dash">
  <h2>üìä Dashboard (Aujourd‚Äôhui)</h2>
  <div class="bar">
    <button class="primary" onclick="loadOrders(true)">üîÑ Mettre √† jour</button>
    <span class="muted">Bas√© sur les commandes du jour.</span>
  </div>

  <div class="cards">
    <div class="card">
      <h3>Commandes (jour)</h3>
      <div class="big" id="dOrders">0</div>
      <div class="muted" id="dOrdersSub">-</div>
    </div>
    <div class="card">
      <h3>Total (jour)</h3>
      <div class="big" id="dTotal">0</div>
      <div class="muted">HTG</div>
    </div>
    <div class="card">
      <h3>Produits vendus</h3>
      <div class="big" id="dItems">0</div>
      <div class="muted">quantit√© totale</div>
    </div>
  </div>

  <h3 style="margin-top:14px">Top produits vendus (jour)</h3>
  <table id="topTable"></table>
</section>

<div class="toast" id="toast"></div>

<script>
  // ===== CONFIG =====
  var API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec"; // <-- remplace
  var ADMIN_KEY = "";

  // ===== STATE =====
  var AUTO_ON = true;
  var AUTO_MS = 12000;
  var autoTimer = null;

  var lastOrderIdsArr = [];
  try { lastOrderIdsArr = JSON.parse(localStorage.getItem("bes_admin_last_ids") || "[]"); } catch(e){ lastOrderIdsArr = []; }

  var lastOrdersCache = [];
  var productsCache = [];

  // ===== INIT =====
  (function(){
    ADMIN_KEY = getKeyFromHash();
    if (!ADMIN_KEY) alert("Lien admin invalide : ajoute #k=TA_CLE √† l‚ÄôURL");

    startAuto();
    loadOrders(true);
  })();

  function getKeyFromHash(){
    var h = window.location.hash || "";
    var m = h.match(/k=([^&]+)/);
    if (!m) return "";
    try { return decodeURIComponent(m[1]); } catch(e){ return m[1]; }
  }

  function showTab(id){
    var secs = document.querySelectorAll("section");
    for (var i=0;i<secs.length;i++) secs[i].classList.remove("active");
    document.getElementById(id).classList.add("active");

    document.getElementById("tabOrders").classList.remove("active");
    document.getElementById("tabProducts").classList.remove("active");
    document.getElementById("tabDash").classList.remove("active");

    if (id==="orders") document.getElementById("tabOrders").classList.add("active");
    if (id==="products") document.getElementById("tabProducts").classList.add("active");
    if (id==="dash") document.getElementById("tabDash").classList.add("active");

    if (id==="products") loadProducts();
    if (id==="dash") renderDashboardFromCache();
  }

  function toast(msg){
    var t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(function(){ t.style.display="none"; }, 2500);
  }

  // ===== JSONP =====
  function jsonp(action, params, cb){
    params = params || {};
    var callback = "cb_" + Math.random().toString(36).slice(2);

    params.action = action;
    params.k = ADMIN_KEY;
    params.callback = callback;

    var q = [];
    for (var k in params) {
      if (params.hasOwnProperty(k)) q.push(k + "=" + encodeURIComponent(params[k]));
    }

    var s = document.createElement("script");
    s.src = API_URL + "?" + q.join("&");

    var done = false;
    var timeout = setTimeout(function(){
      if (done) return;
      done = true;
      try { delete window[callback]; } catch(e){}
      try { s.parentNode.removeChild(s); } catch(e){}
      cb({ ok:false, error:"Timeout API" });
    }, 15000);

    window[callback] = function(res){
      if (done) return;
      done = true;
      clearTimeout(timeout);
      try { delete window[callback]; } catch(e){}
      try { s.parentNode.removeChild(s); } catch(e){}
      cb(res);
    };

    document.body.appendChild(s);
  }

  // ===== AUTO =====
  function startAuto(){
    stopAuto();
    if (!AUTO_ON) { document.getElementById("autoState").textContent = "OFF"; return; }
    document.getElementById("autoState").textContent = "ON";
    autoTimer = setInterval(function(){ loadOrders(false); }, AUTO_MS);
  }
  function stopAuto(){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }
  function toggleAuto(){
    AUTO_ON = !AUTO_ON;
    startAuto();
    toast("Auto-refresh: " + (AUTO_ON ? "ON" : "OFF"));
  }

  // ===== SOUND =====
  function beep(){
    try {
      var AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      var ctx = new AudioCtx();
      var o = ctx.createOscillator();
      var g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.06;
      o.start();
      setTimeout(function(){
        try { o.stop(); } catch(e){}
        try { ctx.close(); } catch(e){}
      }, 160);
    } catch(e){}
  }
  function testBeep(){ beep(); toast("Test son üîî"); }

  // ===== COMMANDES =====
  function loadOrders(manual){
    var status = document.getElementById("statusFilter").value || "";
    var params = {};
    if (status) params.status = status;

    jsonp("admin_listOrders", params, function(res){
      document.getElementById("lastSync").textContent = (new Date()).toLocaleTimeString();

      var ordersMsg = document.getElementById("ordersMsg");
      var el = document.getElementById("ordersTable");

      if (!res || !res.ok) {
        var msg = (res && (res.error || res.message)) ? (res.error || res.message) : "Erreur";
        ordersMsg.innerHTML = "<span class='err'>" + esc(msg) + "</span>";
        el.innerHTML = "<tr><td>" + esc(msg) + "</td></tr>";
        return;
      }

      ordersMsg.innerHTML = "";
      var orders = res.orders && res.orders.length ? res.orders : [];
      lastOrdersCache = orders;

      // detect new "Re√ßue"
      var newCount = 0;
      for (var i=0;i<orders.length;i++){
        var o = orders[i];
        var id = String(o.OrderID || o.orderId || "");
        var stat = String(o.Statut || "");
        if (id && stat==="Re√ßue" && !arrayHas(lastOrderIdsArr, id)) newCount++;
      }
      if (newCount > 0) { beep(); toast("Nouvelle commande (" + newCount + ") ‚úÖ"); }

      // store ids
      for (var j=0;j<orders.length;j++){
        var oid = String(orders[j].OrderID || orders[j].orderId || "");
        if (oid && !arrayHas(lastOrderIdsArr, oid)) lastOrderIdsArr.push(oid);
      }
      try { localStorage.setItem("bes_admin_last_ids", JSON.stringify(lastOrderIdsArr)); } catch(e){}

      // render table
      var html = "<tr><th>Date</th><th>Client</th><th>T√©l√©phone</th><th>Type</th><th>Total</th><th>Statut</th><th>R√©sum√©</th><th>Actions</th></tr>";
      for (var k=0;k<orders.length;k++){
        var x = orders[k];
        var orderId = String(x.OrderID || "");
        var st = String(x.Statut || "");
        var rowClass = (st==="Re√ßue") ? "new" : "";

        var resume = x.ResumeItems || "";
        if (!resume && x.items && x.items.length){
          var parts = [];
          for (var t=0;t<x.items.length;t++){
            var it = x.items[t];
            parts.push((it.Nom||"") + "(" + (it.Quantite||0) + ")");
          }
          resume = parts.join(", ");
        }

        html += "<tr class='" + rowClass + "'>" +
          "<td>" + esc(fmtDate(x.DateHeure)) + "</td>" +
          "<td><b>" + esc(x.ClientNom || "") + "</b><br><span class='muted'>" + esc(x.Adresse || "") + "</span></td>" +
          "<td>" + esc(x.Telephone || "") + "</td>" +
          "<td>" + esc(x.TypeCommande || "") + "</td>" +
          "<td>" + esc(x.Total || "") + "</td>" +
          "<td>" + esc(st) + "</td>" +
          "<td>" + esc(resume || "") + "</td>" +
          "<td>" +
            "<button class='small' onclick=\"setStatus('" + escAttr(orderId) + "','Pr√™te')\">Pr√™te</button> " +
            "<button class='small' onclick=\"setStatus('" + escAttr(orderId) + "','Termin√©e')\">Termin√©e</button> " +
            "<button class='small' onclick=\"setStatus('" + escAttr(orderId) + "','Annul√©e')\">Annuler</button> " +
            "<button class='small' onclick=\"printTicket('" + escAttr(orderId) + "')\">üñ® Ticket</button>" +
          "</td>" +
        "</tr>";
      }
      el.innerHTML = html;

      renderDashboardFromCache();
    });
  }

  function setStatus(orderId, status){
    jsonp("admin_setOrderStatus", { orderId: orderId, status: status }, function(res){
      if (!res || !res.ok) return toast("Erreur: " + (res && (res.error||res.message) ? (res.error||res.message) : "status"));
      toast("Statut ‚Üí " + status);
      loadOrders(true);
    });
  }

  function printTicket(orderId){
    var o = null;
    for (var i=0;i<lastOrdersCache.length;i++){
      if (String(lastOrdersCache[i].OrderID||"") === String(orderId)) { o = lastOrdersCache[i]; break; }
    }
    if (!o) { toast("Commande introuvable"); return; }

    var items = (o.items && o.items.length) ? o.items : [];
    var w = window.open("", "_blank", "width=380,height=700");
    if (!w) { alert("Popup bloqu√©e. Autorise les popups pour imprimer."); return; }

    var rows = "";
    for (var j=0;j<items.length;j++){
      var it = items[j];
      rows += "<tr>" +
        "<td>" + esc(it.Nom || "") + "</td>" +
        "<td style='text-align:right'>" + esc(it.Quantite || 0) + "</td>" +
        "<td style='text-align:right'>" + esc(it.SousTotal || "") + "</td>" +
      "</tr>";
    }
    if (!rows) rows = "<tr><td colspan='3'>Aucun item</td></tr>";

    var isDelivery = String(o.TypeCommande||"").toLowerCase() === "livraison";
    var addrLine = isDelivery ? ("<div><b>Adresse:</b> " + esc(o.Adresse||"") + "</div>") : "";
    var noteLine = o.NoteCommande ? ("<div><b>Note:</b> " + esc(o.NoteCommande) + "</div>") : "";

    var page =
      "<html><head><meta charset='utf-8'/>" +
      "<title>Ticket " + esc(orderId) + "</title>" +
      "<style>" +
      "body{font-family:Arial,sans-serif;margin:12px;}h2{margin:0 0 6px;}.muted{color:#666;font-size:12px;}" +
      "table{width:100%;border-collapse:collapse;margin-top:8px;}td,th{border-bottom:1px dashed #ccc;padding:6px 0;font-size:13px;}" +
      ".tot{font-size:16px;font-weight:700;margin-top:10px;}.hr{border-top:1px solid #000;margin:10px 0;}" +
      "</style></head><body>" +
      "<h2>BES Fast Food</h2><div class='muted'>Ticket cuisine</div><div class='hr'></div>" +
      "<div><b>Commande:</b> " + esc(orderId) + "</div>" +
      "<div><b>Date:</b> " + esc(fmtDate(o.DateHeure)) + "</div>" +
      "<div><b>Client:</b> " + esc(o.ClientNom||"") + "</div>" +
      "<div><b>T√©l:</b> " + esc(o.Telephone||"") + "</div>" +
      "<div><b>Type:</b> " + esc(o.TypeCommande||"") + "</div>" +
      addrLine + noteLine +
      "<div class='hr'></div>" +
      "<table><tr><th>Produit</th><th style='text-align:right'>Qt√©</th><th style='text-align:right'>Sous-total</th></tr>" +
      rows +
      "</table>" +
      "<div class='tot'>TOTAL: " + esc(o.Total || 0) + " HTG</div>" +
      "<script>window.onload=function(){window.print();};</" + "script>" +
      "</body></html>";

    w.document.write(page);
    w.document.close();
  }

  // ===== PRODUITS =====
  function loadProducts(){
    jsonp("admin_listProducts", {}, function(res){
      var el = document.getElementById("productsTable");
      if (!res || !res.ok) {
        el.innerHTML = "<tr><td>" + esc(res && (res.error||res.message) ? (res.error||res.message) : "Erreur") + "</td></tr>";
        return;
      }

      productsCache = res.products && res.products.length ? res.products : [];

      // datalists (sans Set)
      var catObj = {};
      var pidHtml = "";
      for (var i=0;i<productsCache.length;i++){
        var p = productsCache[i];
        var pid = String(p.ProductID||"");
        pidHtml += "<option value=\"" + escAttr(pid) + "\"></option>";
        if (p.Categorie) catObj[String(p.Categorie)] = true;
      }
      document.getElementById("prodIdList").innerHTML = pidHtml;

      var cats = [];
      for (var c in catObj) if (catObj.hasOwnProperty(c)) cats.push(c);
      cats.sort();
      var catHtml = "";
      for (var j=0;j<cats.length;j++) catHtml += "<option value=\"" + escAttr(cats[j]) + "\"></option>";
      document.getElementById("catList").innerHTML = catHtml;

      var html = "<tr><th>ID</th><th>Nom</th><th>Cat.</th><th>Prix</th><th>Stock</th><th>Maj stock</th></tr>";
      for (var k=0;k<productsCache.length;k++){
        var x = productsCache[k];
        var id = String(x.ProductID||"");
        html += "<tr class='prodRow' data-idx='" + k + "'>" +
          "<td><b>" + esc(id) + "</b></td>" +
          "<td>" + esc(x.Nom||"") + "</td>" +
          "<td>" + esc(x.Categorie||"") + "</td>" +
          "<td>" + esc(x.Prix||0) + "</td>" +
          "<td>" + esc(x.Stock||0) + "</td>" +
          "<td>" +
            "<input style='max-width:120px' type='number' id='stk_" + escAttr(id) + "' value='" + escAttr(x.Stock||0) + "' onclick='event.stopPropagation()' /> " +
            "<button class='small' onclick=\"event.stopPropagation(); quickStock('" + escAttr(id) + "')\">OK</button>" +
          "</td>" +
        "</tr>";
      }
      el.innerHTML = html;

      // bind clicks
      var rows = document.querySelectorAll("#productsTable .prodRow");
      for (var r=0;r<rows.length;r++){
        rows[r].addEventListener("click", function(){
          var idx = Number(this.getAttribute("data-idx"));
          fillProduct(productsCache[idx]);
        });
      }

      document.getElementById("prodMsg").innerHTML = "<span class='ok'>Produits charg√©s ‚úÖ</span>";
    });
  }

  function fillProduct(p){
    document.getElementById("pId").value = p.ProductID || "";
    document.getElementById("pName").value = p.Nom || "";
    document.getElementById("pCat").value = p.Categorie || "";
    document.getElementById("pPrice").value = p.Prix || 0;
    document.getElementById("pStock").value = p.Stock || 0;
  }

  function clearForm(){
    document.getElementById("pId").value = "";
    document.getElementById("pName").value = "";
    document.getElementById("pCat").value = "";
    document.getElementById("pPrice").value = "";
    document.getElementById("pStock").value = "";
    document.getElementById("prodMsg").innerHTML = "";
  }

  function saveProduct(){
    var pid = (document.getElementById("pId").value || "").trim();
    var nom = (document.getElementById("pName").value || "").trim();
    var cat = (document.getElementById("pCat").value || "").trim();
    var prix = Number(document.getElementById("pPrice").value || 0);
    var stock = Number(document.getElementById("pStock").value || 0);

    if (!pid || !nom) {
      document.getElementById("prodMsg").innerHTML = "<span class='err'>ProductID et Nom obligatoires</span>";
      return;
    }

    var product = { ProductID: pid, Nom: nom, Categorie: cat, Prix: prix, Stock: stock };

    jsonp("admin_upsertProduct", { product: JSON.stringify(product) }, function(res){
      if (res && res.ok) {
        document.getElementById("prodMsg").innerHTML = "<span class='ok'>Enregistr√© ‚úÖ</span>";
        loadProducts();
      } else {
        document.getElementById("prodMsg").innerHTML = "<span class='err'>" + esc(res && (res.error||res.message) ? (res.error||res.message) : "Erreur") + "</span>";
      }
    });
  }

  function deactivateProduct(){
    var pid = (document.getElementById("pId").value || "").trim();
    if (!pid) { document.getElementById("prodMsg").innerHTML = "<span class='err'>Entre ProductID</span>"; return; }
    if (!confirm("D√©sactiver " + pid + " ?")) return;

    jsonp("admin_deleteProduct", { productId: pid }, function(res){
      if (res && res.ok) {
        document.getElementById("prodMsg").innerHTML = "<span class='ok'>D√©sactiv√© ‚úÖ</span>";
        loadProducts();
      } else {
        document.getElementById("prodMsg").innerHTML = "<span class='err'>" + esc(res && (res.error||res.message) ? (res.error||res.message) : "Erreur") + "</span>";
      }
    });
  }

  function quickStock(productId){
    var inp = document.getElementById("stk_" + productId);
    var stock = Number((inp && inp.value) ? inp.value : 0);

    jsonp("admin_updateStock", { productId: productId, stock: stock }, function(res){
      if (!res || !res.ok) return toast("Erreur stock: " + (res && (res.error||res.message) ? (res.error||res.message) : ""));
      toast("Stock OK ‚úÖ");
      loadProducts();
    });
  }

  // ===== DASHBOARD =====
  function renderDashboardFromCache(){
    var orders = lastOrdersCache || [];
    var todayKey = (new Date()).toISOString().slice(0,10);

    var todays = [];
    for (var i=0;i<orders.length;i++){
      var d = parseDateAny(orders[i].DateHeure);
      if (d && d.toISOString().slice(0,10) === todayKey) todays.push(orders[i]);
    }

    var count = todays.length;
    var total = 0;
    var itemsQty = 0;
    var byName = {}; // name -> qty

    for (var j=0;j<todays.length;j++){
      total += Number(todays[j].Total || 0);
      var items = (todays[j].items && todays[j].items.length) ? todays[j].items : [];
      for (var k=0;k<items.length;k++){
        var it = items[k];
        var name = String(it.Nom || it.ProductID || "").trim();
        var q = Number(it.Quantite || 0);
        if (!name) continue;
        itemsQty += q;
        byName[name] = (byName[name] || 0) + q;
      }
    }

    document.getElementById("dOrders").textContent = String(count);
    document.getElementById("dOrdersSub").textContent = "Date: " + todayKey;
    document.getElementById("dTotal").textContent = String(total);
    document.getElementById("dItems").textContent = String(itemsQty);

    // top
    var arr = [];
    for (var n in byName) if (byName.hasOwnProperty(n)) arr.push([n, byName[n]]);
    arr.sort(function(a,b){ return b[1]-a[1]; });

    var topHtml = "<tr><th>Produit</th><th>Quantit√©</th></tr>";
    if (!arr.length) topHtml += "<tr><td colspan='2'>Aucune vente aujourd‚Äôhui</td></tr>";
    else {
      var max = arr.length > 15 ? 15 : arr.length;
      for (var t=0;t<max;t++){
        topHtml += "<tr><td>" + esc(arr[t][0]) + "</td><td>" + esc(arr[t][1]) + "</td></tr>";
      }
    }
    document.getElementById("topTable").innerHTML = topHtml;
  }

  // ===== HELPERS =====
  function arrayHas(arr, v){
    for (var i=0;i<arr.length;i++) if (String(arr[i]) === String(v)) return true;
    return false;
  }

  function esc(s){
    s = (s === undefined || s === null) ? "" : String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
    });
  }
  function escAttr(s){
    s = (s === undefined || s === null) ? "" : String(s);
    return s.replace(/"/g,"&quot;");
  }
  function parseDateAny(v){
    if (!v) return null;
    if (v instanceof Date) return v;
    var d = new Date(String(v));
    if (isNaN(d.getTime())) return null;
    return d;
  }
  function fmtDate(v){
    var d = parseDateAny(v);
    if (!d) return String(v || "");
    return d.toLocaleString();
  }
</script>

</body>
</html>

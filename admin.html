<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BES Admin</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#a7b0c0;
      --txt:#e9eef8;
      --line: rgba(255,255,255,.10);
      --good:#2E7D32;
      --warn:#FFC107;
      --bad:#D32F2F;
      --btn:#1b2a4a;
      --btn2:#22355e;
      --radius:16px;
      --shadow: 0 12px 32px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(900px 500px at 10% 0%, rgba(255,193,7,.12), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(211,47,47,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:50;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(11,18,32,.85);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1200px;margin:auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sp{justify-content:space-between}
    .brand{font-weight:1000;letter-spacing:1px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-weight:800;font-size:12px}
    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;border-radius:999px;
      font-weight:900;cursor:pointer;
    }
    .tab.active{background: linear-gradient(90deg, rgba(255,193,7,.25), rgba(255,152,0,.15)); border-color: rgba(255,193,7,.25)}
    .btn{
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:900;cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{background:var(--btn2)}
    .btn.good{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.28)}
    .btn.warn{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.28)}
    .btn.bad{background:rgba(211,47,47,.18);border-color:rgba(211,47,47,.28)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .content{padding:14px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .toast{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(46,125,50,.25);background:rgba(46,125,50,.12);color:rgba(185,255,210,.95);font-weight:900}
    .err{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(211,47,47,.25);background:rgba(211,47,47,.12);color:rgba(255,200,200,.95);font-weight:900}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:900;font-size:12px}
    .badge.good{border-color:rgba(46,125,50,.35);color:rgba(185,255,210,.95)}
    .badge.bad{border-color:rgba(211,47,47,.35);color:rgba(255,200,200,.95)}
    .badge.warn{border-color:rgba(255,193,7,.35);color:rgba(255,240,200,.95)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .grid{display:grid;grid-template-columns: 2fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .menuGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:560px){.menuGrid{grid-template-columns:1fr}}
    .prod{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.05);
      padding:10px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .mini{
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--txt);font-weight:900;cursor:pointer;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap row sp">
    <div class="row">
      <div class="brand">BES Admin</div>
      <div class="pill">Admin v2 • POS 80mm</div>
    </div>
    <div class="row">
      <button class="btn" id="refreshBtn" type="button">Actualiser</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="cardHead">
      <div class="tabs">
        <button class="tab active" data-tab="orders">Commandes</button>
        <button class="tab" data-tab="products">Produits</button>
        <button class="tab" data-tab="place">Placer une commande</button>
      </div>

      <div class="row">
        <input id="adminKey" placeholder="ADMIN KEY (obligatoire pour commandes/prod)" style="max-width:340px" />
        <select id="statusFilter" style="max-width:240px">
          <option value="">Tous statuts</option>
          <option>Reçue</option>
          <option>Prêt à consommer</option>
          <option>Prêt à emporter</option>
          <option>Prêt à livrer</option>
          <option>Annuler</option>
        </select>
      </div>
    </div>

    <div class="content">
      <div id="toast" class="toast"></div>
      <div id="err" class="err"></div>

      <!-- ORDERS -->
      <section id="tab-orders">
        <div class="card">
          <div class="content" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Type</th>
                  <th>Commande</th>
                  <th>Total</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="7" class="muted">Chargement…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS -->
      <section id="tab-products" style="display:none">
        <div class="card">
          <div class="cardHead">
            <b>Produits</b>
            <div class="row">
              <button class="btn" id="reloadProductsBtn" type="button">Recharger</button>
            </div>
          </div>
          <div class="content" id="productsBox" class="muted">Chargement…</div>
        </div>
      </section>

      <!-- PLACE ORDER -->
      <section id="tab-place" style="display:none">
        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <b>Menu (stock > 0)</b>
              <div class="row">
                <button class="btn" type="button" id="reloadMenuBtn">Recharger</button>
              </div>
            </div>
            <div class="content">
              <input id="menuSearch" placeholder="Recherche…" />
              <div class="hr"></div>
              <div id="menuBox" class="muted">Chargement…</div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Panier (vente)</b>
              <button class="btn bad" type="button" id="clearPlaceCartBtn">Vider</button>
            </div>
            <div class="content">
              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Nom</label>
                  <input id="p_name" placeholder="Ex: Client comptoir" />
                </div>
                <div style="flex:1">
                  <label>Téléphone</label>
                  <input id="p_phone" placeholder="Ex: +509..." />
                </div>
              </div>

              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Type de commande</label>
                  <select id="p_type">
                    <option>Sur place</option>
                    <option>À emporter</option>
                    <option>Livraison</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label>Paiement (obligatoire)</label>
                  <select id="p_pay">
                    <option value="">Choisir…</option>
                    <option>Moncash</option>
                    <option>Natcash</option>
                  </select>
                </div>
              </div>

              <div id="p_addrWrap" style="display:none;margin-bottom:10px">
                <label>Adresse (livraison)</label>
                <textarea id="p_addr" placeholder="Adresse…"></textarea>
              </div>

              <label>Note (optionnel)</label>
              <textarea id="p_note" placeholder="Ex: sans piment…"></textarea>

              <div class="hr"></div>
              <div id="placeCartItems" class="muted">Panier vide</div>

              <div class="hr"></div>
              <div class="row sp">
                <b>Total</b>
                <b id="placeTotal">0.00 HTG</b>
              </div>

              <div style="margin-top:12px">
                <button class="btn good" type="button" id="placeOrderBtn" disabled>Enregistrer (Sheets)</button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
/***************
 * CONFIG
 ***************/
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec"; // <-- Mets ton lien /exec ici
const DEFAULT_COUNTRY_CODE = "509";

/***************
 * JSONP helper
 ***************/
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    if(!API_URL || API_URL.includes("PASTE_")){
      reject(new Error("API_URL manquant. Mets ton lien Apps Script /exec dans API_URL."));
      return;
    }
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const url = API_URL + "?" + q;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;

    let done = false;
    const timer = setTimeout(()=> {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout API"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch(e){}
      try { s.remove(); } catch(e){}
    }

    window[cb] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("API error"));
    };

    document.head.appendChild(s);
  });
}

/***************
 * UI helpers
 ***************/
const $ = (id)=>document.getElementById(id);
function toast(msg){
  $("toast").style.display="block";
  $("toast").textContent=String(msg||"");
  setTimeout(()=>{$("toast").style.display="none";}, 3500);
}
function showErr(msg){
  $("err").style.display="block";
  $("err").textContent=String(msg||"Erreur");
  setTimeout(()=>{$("err").style.display="none";}, 6500);
}
function fmtHTG(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}) + " HTG";
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function norm(s){ return String(s||"").toLowerCase().trim(); }

/***************
 * WhatsApp helpers (CLIENT)
 ***************/
function digitsOnlyPhone(raw){
  let d = String(raw||"").replace(/\D/g,"");
  if(d.length === 8) d = DEFAULT_COUNTRY_CODE + d;
  return d;
}
function openWhatsAppToClient(phone, message){
  const p = digitsOnlyPhone(phone);
  if(!p){
    showErr("Téléphone client invalide.");
    return;
  }
  const url = "https://wa.me/" + p + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

/***************
 * Tabs
 ***************/
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    $("tab-orders").style.display   = (tab==="orders") ? "block" : "none";
    $("tab-products").style.display = (tab==="products") ? "block" : "none";
    $("tab-place").style.display    = (tab==="place") ? "block" : "none";

    if(tab==="orders") loadOrders();
    if(tab==="products") loadProducts();
    if(tab==="place") loadMenuForPlace();
  });
});

$("refreshBtn").addEventListener("click", ()=>{
  const active = document.querySelector(".tab.active")?.dataset?.tab || "orders";
  if(active==="orders") loadOrders();
  if(active==="products") loadProducts();
  if(active==="place") loadMenuForPlace();
});
$("statusFilter").addEventListener("change", loadOrders);

/***************
 * Orders
 ***************/
async function loadOrders(){
  try{
    const k = $("adminKey").value.trim();
    const status = $("statusFilter").value.trim();

    const r = await apiJsonp("admin_listOrders", { k, limit:"120", status });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listOrders");

    const orders = Array.isArray(r.orders) ? r.orders : [];
    const tb = $("ordersTbody");

    if(orders.length===0){
      tb.innerHTML = `<tr><td colspan="7" class="muted">Aucune commande.</td></tr>`;
      return;
    }

    tb.innerHTML = orders.map(o=>{
      const type = o.TypeCommande || "";
      const isSurPlace = /sur\s*place/i.test(type);
      const isEmporter = /(à|a)\s*emporter/i.test(type);

      const st = (o.Statut || "-");
      const badgeClass =
        /annul/i.test(st) ? "badge bad" :
        /prêt|pret/i.test(st) ? "badge good" :
        /reç/i.test(st) ? "badge warn" : "badge";

      const safeOrderJson = JSON.stringify(o).replace(/</g,"\\u003c");

      return `
        <tr>
          <td>${escapeHtml(o.DateHeure || "")}</td>
          <td><b>${escapeHtml(o.ClientNom || "")}</b><div class="muted">${escapeHtml(o.Telephone || "")}</div></td>
          <td>${escapeHtml(type)}</td>
          <td>${escapeHtml((o.ResumeItems||"") + "")}</td>
          <td><b>${fmtHTG(o.Total||0)}</b></td>
          <td><span class="${badgeClass}">${escapeHtml(st)}</span></td>
          <td>
            <div class="actions">
              ${isSurPlace ? `
                <button class="btn good" type="button" onclick='readyConsume(${safeOrderJson})'>
                  Prêt à consommer
                </button>
              ` : ``}

              ${isEmporter ? `
                <button class="btn good" type="button" onclick='readyTakeaway(${safeOrderJson})'>
                  Prêt à emporter
                </button>
              ` : ``}

              <button class="btn" type="button" onclick='printPOS80(${safeOrderJson})'>
                Imprimer 80mm
              </button>

              <button class="btn bad" type="button"
                onclick="setStatus('${String(o.OrderID||"").replace(/'/g,"")}', 'Annuler')">
                Annuler
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

  }catch(e){
    showErr(e.message || e);
    $("ordersTbody").innerHTML = `<tr><td colspan="7" class="muted">Erreur de chargement.</td></tr>`;
  }
}

window.setStatus = async function(orderId, status){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_setOrderStatus", { k, orderId, status });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_setOrderStatus");
    toast("Statut mis à jour ✅");
    loadOrders();
  }catch(e){
    showErr(e.message || e);
  }
};

window.readyConsume = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Prêt à consommer");
    openWhatsAppToClient(order.Telephone, "Votre commande est prête à consommer. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

window.readyTakeaway = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Prêt à emporter");
    openWhatsAppToClient(order.Telephone, "Votre commande est prête à emporter. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

/***************
 * Print POS 80mm (✅ correction: </script> => <\/script>)
 ***************/
window.printPOS80 = function(order){
  try{
    const items = Array.isArray(order.items) ? order.items : [];
    const resume = String(order.ResumeItems||"").trim();

    const rows = items.length
      ? items.map(i=>{
          const name = escapeHtml(i.Nom||"");
          const q = Number(i.Quantite||0);
          const st = fmtHTG(i.SousTotal||0);
          return `<tr><td class="name">${name}</td><td class="qty">${q}</td><td class="amt">${st}</td></tr>`;
        }).join("")
      : `<tr><td colspan="3">${escapeHtml(resume)}</td></tr>`;

    const w = window.open("", "_blank", "width=420,height=800");
    w.document.write(`<!doctype html>
<html><head><meta charset="utf-8"/>
<title>POS 80mm</title>
<style>
  @page { size: 80mm auto; margin: 6mm; }
  body{ width:80mm; margin:0; font-family: Arial, sans-serif; color:#000; }
  .center{text-align:center}
  .muted{color:#444;font-size:11px}
  h1{font-size:16px;margin:0;font-weight:800}
  .hr{border-top:1px dashed #000;margin:8px 0}
  table{width:100%;border-collapse:collapse;font-size:12px}
  td{padding:4px 0;vertical-align:top}
  td.name{width:60%}
  td.qty{width:10%;text-align:right}
  td.amt{width:30%;text-align:right}
  .tot{font-size:14px;font-weight:800;text-align:right;margin-top:8px}
  .small{font-size:11px}
</style>
</head>
<body>
  <div class="center">
    <h1>BES FAST FOOD</h1>
    <div class="muted small">${escapeHtml(order.DateHeure||"")}</div>
  </div>

  <div class="hr"></div>

  <div class="small"><b>Client:</b> ${escapeHtml(order.ClientNom||"")}</div>
  <div class="small"><b>Tél:</b> ${escapeHtml(order.Telephone||"")}</div>
  <div class="small"><b>Type:</b> ${escapeHtml(order.TypeCommande||"")}</div>
  ${order.Adresse ? `<div class="small"><b>Adresse:</b> ${escapeHtml(order.Adresse||"")}</div>` : ``}

  <div class="hr"></div>

  <table><tbody>${rows}</tbody></table>

  <div class="hr"></div>
  <div class="tot">TOTAL: ${fmtHTG(order.Total||0)}</div>

  <div class="hr"></div>
  <div class="center muted small">Merci d'avoir choisi BES Fast Food!</div>

  <script>window.onload=function(){window.print();};<\/script>
</body></html>`);
    w.document.close();
  }catch(e){
    showErr("Impression: " + (e.message || e));
  }
};

/***************
 * Products
 ***************/
async function loadProducts(){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_listProducts", { k });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listProducts");

    const list = Array.isArray(r.products) ? r.products : [];
    if(list.length===0){
      $("productsBox").innerHTML = `<div class="muted">Aucun produit.</div>`;
      return;
    }

    const html = list.map(p=>{
      const actif = String(p.Actif || "TRUE").toUpperCase() !== "FALSE";
      const stock = Number(p.Stock || 0);
      return `
        <div class="prod" style="margin-bottom:10px">
          <div style="min-width:0">
            <b>${escapeHtml(p.Nom||"")}</b>
            <div class="muted">${escapeHtml(p.Categorie||"")}</div>
            <div class="muted">Prix: <b>${fmtHTG(p.Prix||0)}</b> • Stock: <b>${stock}</b> • Actif: <b>${actif ? "Oui" : "Non"}</b></div>
          </div>
          <div>
            <span class="badge ${stock>0 && actif ? "good":"bad"}">${stock>0 && actif ? "En vente" : "Hors vente"}</span>
          </div>
        </div>
      `;
    }).join("");

    $("productsBox").innerHTML = html;

  }catch(e){
    showErr(e.message || e);
    $("productsBox").textContent = "Erreur.";
  }
}

$("reloadProductsBtn").addEventListener("click", loadProducts);

/***************
 * Place order (submitOrderLite + getProducts)
 ***************/
let menuProducts = [];
const placeCart = {}; // { productId: qty }

function syncPlaceAddr(){
  const isLiv = norm($("p_type").value)==="livraison";
  $("p_addrWrap").style.display = isLiv ? "block" : "none";
  if(!isLiv) $("p_addr").value="";
}
function calcPlaceTotal(){
  let total = 0;
  for(const [pid, qty] of Object.entries(placeCart)){
    const p = menuProducts.find(x=>String(x.ProductID)===String(pid));
    if(!p) continue;
    total += Number(p.Prix||0) * Number(qty||0);
  }
  return total;
}
function renderPlaceCart(){
  const entries = Object.entries(placeCart);
  $("placeTotal").textContent = fmtHTG(calcPlaceTotal());

  if(entries.length===0){
    $("placeCartItems").innerHTML = `<div class="muted">Panier vide</div>`;
  }else{
    $("placeCartItems").innerHTML = entries.map(([pid, qty])=>{
      const p = menuProducts.find(x=>String(x.ProductID)===String(pid));
      const name = p ? p.Nom : ("Produit " + pid);
      const sub = (p ? Number(p.Prix||0) : 0) * Number(qty||0);
      return `
        <div class="row sp" style="margin:6px 0">
          <div style="min-width:0">
            <b>${escapeHtml(name)}</b>
            <div class="muted">${fmtHTG(p?.Prix||0)} × ${qty} = <b>${fmtHTG(sub)}</b></div>
          </div>
          <div class="row" style="gap:6px">
            <button class="mini" type="button" onclick="placeQty('${pid}', ${Number(qty)-1})">−</button>
            <button class="mini" type="button" onclick="placeQty('${pid}', ${Number(qty)+1})">+</button>
            <button class="mini" type="button" onclick="placeRm('${pid}')">x</button>
          </div>
        </div>
      `;
    }).join("");
  }
  validatePlaceOrderBtn();
}
window.placeQty = function(pid, q){
  const next = Number(q||0);
  if(next <= 0) delete placeCart[pid];
  else placeCart[pid] = next;
  renderPlaceCart();
};
window.placeRm = function(pid){
  delete placeCart[pid];
  renderPlaceCart();
};
window.placeAdd = function(pid){
  placeCart[String(pid)] = (Number(placeCart[String(pid)]||0) + 1);
  renderPlaceCart();
};

function validatePlaceOrderBtn(){
  const itemsCount = Object.keys(placeCart).length;
  const nameOk = !!$("p_name").value.trim();
  const phoneOk = !!$("p_phone").value.trim();
  const payOk = !!$("p_pay").value.trim();
  const isLiv = norm($("p_type").value)==="livraison";
  const addrOk = !isLiv || !!$("p_addr").value.trim();
  $("placeOrderBtn").disabled = !(itemsCount>0 && nameOk && phoneOk && payOk && addrOk);
}

function renderMenu(){
  const q = norm($("menuSearch").value);
  const list = menuProducts.filter(p=>{
    const hay = norm(p.Nom) + " " + norm(p.Categorie);
    return !q || hay.includes(q);
  });

  if(list.length===0){
    $("menuBox").innerHTML = `<div class="muted">Aucun produit trouvé.</div>`;
    return;
  }

  $("menuBox").innerHTML = `
    <div class="menuGrid">
      ${list.map(p=>{
        return `
          <div class="prod">
            <div style="min-width:0">
              <b>${escapeHtml(p.Nom||"")}</b>
              <div class="muted">${escapeHtml(p.Categorie||"")}</div>
              <div class="muted">Prix: <b>${fmtHTG(p.Prix||0)}</b> • Stock: ${escapeHtml(p.Stock||"")}</div>
            </div>
            <div>
              <button class="btn good" type="button" onclick="placeAdd('${String(p.ProductID).replace(/'/g,"")}')">Ajouter</button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

async function loadMenuForPlace(){
  try{
    // getProducts filtre déjà stock>0 dans ton Apps Script
    const r = await apiJsonp("getProducts", {});
    if(!r || !r.ok) throw new Error(r?.error || "Erreur getProducts");
    menuProducts = Array.isArray(r.products) ? r.products : [];
    renderMenu();
    renderPlaceCart();
  }catch(e){
    showErr(e.message || e);
    $("menuBox").textContent = "Erreur menu.";
  }
}

$("menuSearch").addEventListener("input", renderMenu);
$("reloadMenuBtn").addEventListener("click", loadMenuForPlace);
$("p_type").addEventListener("change", ()=>{ syncPlaceAddr(); validatePlaceOrderBtn(); });
["p_name","p_phone","p_addr","p_note"].forEach(id=>{
  document.getElementById(id).addEventListener("input", validatePlaceOrderBtn);
});
$("p_pay").addEventListener("change", validatePlaceOrderBtn);

$("clearPlaceCartBtn").addEventListener("click", ()=>{
  for(const k of Object.keys(placeCart)) delete placeCart[k];
  renderPlaceCart();
  toast("Panier vidé ✅");
});

$("placeOrderBtn").addEventListener("click", async ()=>{
  try{
    const items = Object.entries(placeCart).map(([ProductID, Quantite])=>({ ProductID, Quantite }));
    if(items.length===0) throw new Error("Panier vide");

    const payload = {
      guestId: "admin-pos",
      clientNom: $("p_name").value.trim(),
      telephone: $("p_phone").value.trim(),
      typeCommande: $("p_type").value,
      adresse: $("p_addr").value.trim(),
      noteCommande: $("p_note").value.trim(),
      paymentMethod: $("p_pay").value.trim(),
      items
    };

    const r = await apiJsonp("submitOrderLite", { payload: JSON.stringify(payload) });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur submitOrderLite");

    toast("Commande enregistrée ✅ ID: " + (r.orderId || "OK"));

    for(const k of Object.keys(placeCart)) delete placeCart[k];
    $("p_note").value="";
    $("p_addr").value="";
    $("p_type").value="Sur place";
    $("p_pay").value="";
    syncPlaceAddr();
    renderPlaceCart();

    loadMenuForPlace();

  }catch(e){
    showErr(e.message || e);
  }
});

/***************
 * Boot
 ***************/
(function(){
  syncPlaceAddr();
  loadOrders();
})();
</script>
</body>
</html>

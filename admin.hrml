<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BES Fast Food â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background:#f6f6f6; }
    h1 { margin: 0 0 10px; }
    nav button { margin: 4px; padding: 8px 12px; }
    section { display:none; background:#fff; padding:10px; border-radius:6px; }
    section.active { display:block; }
    table { width:100%; border-collapse: collapse; margin-top:8px; }
    th, td { border:1px solid #ccc; padding:6px; font-size:14px; }
    th { background:#eee; }
    tr.new { background:#fff3cd; }
    .ok { color:green; }
    .err { color:red; }
    input, select, textarea { padding:6px; width:100%; }
    .row { display:flex; gap:8px; }
    .row > div { flex:1; }
    .actions button { margin-right:4px; }
  </style>
</head>

<body>

<h1>ğŸ” BES Fast Food â€“ Admin</h1>

<nav>
  <button onclick="show('orders')">ğŸ“¦ Commandes</button>
  <button onclick="show('products')">ğŸŸ Produits</button>
</nav>

<!-- ================= COMMANDES ================= -->
<section id="orders" class="active">
  <h2>ğŸ“¦ Commandes</h2>
  <button onclick="loadOrders()">ğŸ”„ RafraÃ®chir</button>
  <div id="ordersMsg"></div>
  <table id="ordersTable"></table>
</section>

<!-- ================= PRODUITS ================= -->
<section id="products">
  <h2>ğŸŸ Produits</h2>

  <h3>â• Ajouter / Modifier</h3>
  <div class="row">
    <div><input id="pId" placeholder="ProductID" /></div>
    <div><input id="pName" placeholder="Nom" /></div>
    <div><input id="pCat" placeholder="CatÃ©gorie" /></div>
    <div><input id="pPrice" type="number" placeholder="Prix" /></div>
    <div><input id="pStock" type="number" placeholder="Stock" /></div>
  </div>
  <button onclick="saveProduct()">ğŸ’¾ Enregistrer</button>
  <div id="prodMsg"></div>

  <h3>ğŸ“‹ Liste</h3>
  <table id="productsTable"></table>
</section>

<script>
/************ CONFIG ************/
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec"; // <-- IMPORTANT
let ADMIN_KEY = "";

/************ INIT ************/
(function init(){
  const hash = location.hash || "";
  const m = hash.match(/k=([^&]+)/);
  if (m) ADMIN_KEY = m[1];
  if (!ADMIN_KEY) alert("Lien admin invalide (clÃ© manquante)");
  loadOrders();
})();

/************ UI ************/
function show(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/************ JSONP ************/
function jsonp(action, params, cb){
  const callback = "cb_" + Math.random().toString(36).slice(2);
  params = params || {};
  params.action = action;
  params.k = ADMIN_KEY;
  params.callback = callback;

  const q = Object.keys(params).map(k=>k+"="+encodeURIComponent(params[k])).join("&");
  const s = document.createElement("script");
  s.src = API_URL + "?" + q;

  window[callback] = function(res){
    delete window[callback];
    s.remove();
    cb(res);
  };

  document.body.appendChild(s);
}

/************ COMMANDES ************/
function loadOrders(){
  jsonp("admin_listOrders", {}, res=>{
    const el = document.getElementById("ordersTable");
    if (!res.ok) return el.innerHTML = "<tr><td>"+res.error+"</td></tr>";

    let html = "<tr><th>Date</th><th>Client</th><th>TÃ©lÃ©phone</th><th>Total</th><th>Statut</th><th>Actions</th></tr>";
    res.orders.forEach(o=>{
      html += `<tr class="${o.Statut==='ReÃ§ue'?'new':''}">
        <td>${o.DateHeure || ""}</td>
        <td>${o.ClientNom || ""}</td>
        <td>${o.Telephone || ""}</td>
        <td>${o.Total || ""}</td>
        <td>${o.Statut || ""}</td>
        <td class="actions">
          <button onclick="setStatus('${o.OrderID}','PrÃªte')">PrÃªte</button>
          <button onclick="setStatus('${o.OrderID}','TerminÃ©e')">TerminÃ©e</button>
        </td>
      </tr>`;
    });
    el.innerHTML = html;
  });
}

function setStatus(orderId, status){
  jsonp("admin_setOrderStatus", { orderId, status }, res=>{
    alert(res.ok ? "OK" : res.error);
    loadOrders();
  });
}

/************ PRODUITS ************/
function loadProducts(){
  jsonp("admin_listProducts", {}, res=>{
    const el = document.getElementById("productsTable");
    if (!res.ok) return el.innerHTML = "<tr><td>"+res.error+"</td></tr>";

    let html = "<tr><th>ID</th><th>Nom</th><th>Cat.</th><th>Prix</th><th>Stock</th></tr>";
    res.products.forEach(p=>{
      html += `<tr onclick='fillProduct(${JSON.stringify(p)})'>
        <td>${p.ProductID}</td>
        <td>${p.Nom}</td>
        <td>${p.Categorie || ""}</td>
        <td>${p.Prix}</td>
        <td>${p.Stock}</td>
      </tr>`;
    });
    el.innerHTML = html;
  });
}

function fillProduct(p){
  pId.value = p.ProductID || "";
  pName.value = p.Nom || "";
  pCat.value = p.Categorie || "";
  pPrice.value = p.Prix || 0;
  pStock.value = p.Stock || 0;
}

function saveProduct(){
  const product = {
    ProductID: pId.value,
    Nom: pName.value,
    Categorie: pCat.value,
    Prix: Number(pPrice.value),
    Stock: Number(pStock.value)
  };
  jsonp("admin_upsertProduct", { product: JSON.stringify(product) }, res=>{
    prodMsg.innerHTML = res.ok ? "<span class='ok'>EnregistrÃ©</span>" : "<span class='err'>"+res.error+"</span>";
    loadProducts();
  });
}

/************ AUTO ************/
document.querySelector("button[onclick=\"show('products')\"]")
  .addEventListener("click", loadProducts);
</script>

</body>
</html>
